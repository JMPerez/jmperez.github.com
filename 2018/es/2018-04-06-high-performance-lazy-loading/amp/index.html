<!doctype html>
<html ⚡>
  <head>
    <meta charset="utf-8">
    <link rel="canonical" href="https://jmperezperez.com//es/high-performance-lazy-loading" >
    <title>Cómo mejorar la performance de una web usando lazy-loading y code-splitting - Web development, performance, and some other good practices.</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
		<meta name="twitter:card" content="summary_large_image">
		<meta name="twitter:title" content="Cómo mejorar la performance de una web usando lazy-loading y code-splitting - José M. Pérez" property="og:title">
		<meta name="twitter:description" content="Cómo usar un High Order Component para detectar cuándo un elemento está visible y hacer lazy-loading de componentes y secciones de nuestras páginas. Manda al navegador sólo lo que es necesario." property="og:description">
		<meta name="twitter:site" content="@jmperezperez">
		
		<meta property="og:image" content="https://jmperezperez.com/assets/images/posts/observer/high-performance.jpg">
		<meta name="twitter:image" content="https://jmperezperez.com/assets/images/posts/observer/high-performance.jpg">
		
    <noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    
    <script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script>
    
    <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
    

    <script async src="https://cdn.ampproject.org/v0.js"></script>
    <script type="application/ld+json">
		{
			"@context": "http://schema.org",
			"@type": "BlogPosting",
			"headline": "Cómo mejorar la performance de una web usando lazy-loading y code-splitting",
			
			"description": "Cómo usar un High Order Component para detectar cuándo un elemento está visible y hacer lazy-loading de componentes y secciones de nuestras páginas. Manda al navegador sólo lo que es necesario.",
			
			"mainEntityOfPage":{
			    "@type":"WebPage",
			    "@id":"/es/high-performance-lazy-loading"
			},
			"datePublished": "2018-04-06T04:00:00.000Z",
			"dateModified": "2021-12-14T07:52:53.541Z",
			
			"image": {
				"@type": "ImageObject",
				"url": "https://res.cloudinary.com/jmperez/image/upload/w_auto:100:684,f_auto/v1522995807/high-performance_mbjoct.jpg",
				"width" : "700",
				"height" : "365"
			},
			
			"author": {
			    "@type": "Person",
			    "name": "Jose M. Perez"
			},
			"publisher": {
			    "@type": "Organization",
			    "name": "Jose M. Perez&#39;s Blog"
			    
			    ,
			    "logo": {
			      "@type": "ImageObject",
			      "url": "https://jmperezperez.com/amp-dist/logo.png",
			      "width": 600,
			      "height": 60
			    }
			    
			}
		}
	</script>
	<style amp-custom>
		
			/*--RESET--*/
* {
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  border: none;
  font: inherit;
  margin: 0;
  padding: 0;
  vertical-align: baseline;
}

input,
button {
  background: none;
}

html {
  font-size: 18px;
}

@media (max-width: 768px) {
  html {
    font-size: 16px;
  }
}

/*--BODY--*/

body {
  background: #fff;
  color: #555;
  font-family: Georgia, Times;
  font-weight: 300;
  font-style: normal;
  line-height: 1.5rem;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-text-size-adjust: 100%; /* fixes a too large font issue in horizontally scrollable <pre> on webkit */
}

h1,
h2,
h3,
h4,
h5 {
  color: #212121;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-weight: 600;
  line-height: 2rem;
  margin-bottom: 1.5rem;
}

#menu a,
.button {
  font-size: 1em;
  font-weight: 400;
}

p,
.post ul,
.post ol,
iframe,
video,
amp-video,
amp-vimeo,
amp-youtube {
  margin: 0;
  margin-bottom: 1rem;
}

twitterwidget {
  margin-bottom: 1em ;
}

a {
  color: #2a7cb2;
  font-weight: inherit;
  text-decoration: none;
  transition: color 0.15s ease-out, border-bottom-color 0.15s ease-out;
}

a:hover {
  color: #2a7cb2;
}

abbr {
  border-bottom: 1px dashed #ccc;
  text-decoration: none;
}

p a {
  border-bottom: 1px solid #eee;
}

p a:hover {
  border-bottom-color: #212121;
}

strong {
  font-weight: bold;
}

em {
  font-style: italic;
}

h1 {
  font-size: 1.7rem;
}

h2 {
  color: #444;
  display: inline-block;
  font-size: 1.6rem;
  font-weight: 400;
  margin-top: 1rem;
}

h3 {
  color: #666;
  display: inline-block;
  font-size: 1.4rem;
  font-weight: 400;
  margin-top: 1rem;
}

h4 {
  font-size: 1.18rem;
}

h5 {
  font-size: 1rem;
}

a h1,
a h2,
a h3,
a h4,
a h5 {
  transition: color 0.15s ease-out;
}

a:hover h1,
a:hover h2,
a:hover h3,
a:hover h4,
a:hover h5 {
  color: #3498db;
}

.quote {
  margin: 0 0 15px 0;
}

blockquote {
  border-left: 2px solid #ccc;
  font-style: italic;
  margin: 0 0 15px 0;
  padding-left: 20px;
}

ul,
ol {
  margin: 0 0 15px 0;
  padding-left: 25px;
}

ul {
  list-style: square;
}

ol {
  list-style: decimal;
}

hr {
  background: #eee;
  color: #eee;
  clear: both;
  display: block;
  height: 2px;
  margin: 30px auto;
  width: 50%;
}

pre,
code {
  color: #333;
  font-family: Courier, Menlo, Monaco;
  font-size: 0.8em;
  letter-spacing: 0px;
  overflow-x: auto;
}

pre {
  padding: 0.8em 1em;
  white-space: pre-wrap;
}

code {
  margin: 0;
}

/*--CLEARFIXES--*/

.post::after {
  display: block;
  clear: both;
  content: "";
}

/*--HEADER--*/

.main-header {
  background-color: #005689;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  overflow: hidden;
  margin-bottom: 1.5rem;
  padding: 1rem;
  position: relative;
  text-align: center;
  width: 100%;
}

/*--MENU--*/

#menu {
  display: inline-block;
  line-height: 2rem;
}

#menu a {
  color: #fff;
  font-size: 0.9rem;
  margin-left: 1rem;
  padding: 1rem 0.5rem;
  text-transform: uppercase;
}

@media (max-width: 500px) {
  #menu a {
    margin-left: 0.5rem;
    padding: 0.5rem 0.25rem;
  }
}

#menu a:first-child {
  margin-left: 0;
}

#menu a[aria-current] {
  font-weight: bold;
}

/*--PAGE--*/

#page {
  margin: 0 auto;
  max-width: 41rem;
  padding-left: 1.5rem;
  padding-right: 1.5rem;
  position: relative;
}

.videoWrapper {
  height: 0;
  margin-bottom: 1em;
  padding-bottom: 56.25%; /* 16:9 */
  padding-top: 25px;
  position: relative;
}

.videoWrapper iframe,
.videoWrapper amp-youtube {
  height: 100%;
  left: 0;
  position: absolute;
  top: 0;
  width: 100%;
}

/*--WRAPPER--*/

.wrapper {
  border-top: 2px solid #eee;
  padding-top: 2rem;
}

.wrapper:first-child {
  border-top: none;
  padding-top: 1rem;
}

.posts-list h2 {
  margin-top: 0;
}

/*--POSTS--*/

.post {
  display: block;
  margin-bottom: 2rem;
  width: 100%;
}

.post div[itemprop="articleBody"] > p:first-child {
  color: #333;
}

.post li {
  margin-bottom: 0.5rem;
}

.post p + img {
  margin-bottom: 1rem;
}

.post p img {
  border: 1px solid #eee;
  display: block;
  max-width: 100%;
}

.post img + .caption,
.post img + figcaption {
  padding-top: 0.5rem;
}

.post .svg-container {
  margin-bottom: 5%;
  max-width: 100%;
  text-align: center;
}

figure {
  padding-bottom: 1em;
}

video {
  height: auto;
  max-width: 100%;
}

.post .svg-container object {
  width: 100%;
}

.tag-list {
  display: inline-block;
  list-style-type: none;
  margin: 0;
  padding: 0;
  padding-bottom: 1rem;
}

.tag-list-item {
  display: inline-block;
  margin-left: 0.8em;
}

/*--PAGINATION--*/

.pagination {
  padding-bottom: 1rem;
  text-align: center;
}

.pagination a {
  min-width: 30px;
  max-height: 30px;
  text-align: center;
}

/*--FOOTER--*/

footer {
  border-top: 1px dashed #ddd;
  padding: 2em;
  text-align: center;
}

.timing-stats {
  font-size: 0.7em;
  padding: 0.35em;
}

/*--BUTTONS--*/

.button {
  background-color: #fff;
  border: 1px solid #555;
  border-radius: 2rem;
  color: #555;
  display: inline-block;
  padding: 0.5rem 1rem;
  transition: background-color 0.15s ease-out;
}

.button:hover {
  background-color: #3498db;
  border-color: transparent;
  color: #fff;
}

.button.inactive {
  background-color: #ccc;
  color: #fff;
}

/*--404--*/
.search-goog input {
  border: 2px solid #ddd;
  padding: 10px;
}

.search-goog input[type="submit"] {
  background-color: #ddd;
  cursor: pointer;
}

@media (max-width: 768px) {
  /*--PAGE--*/

  #page,
  .wrapper {
    margin: 0;
    max-width: 100%;
    width: 100%;
  }

  /*--WRAPPER--*/

  .wrapper {
    padding-top: 2rem;
  }

  .wraper::after {
    clear: both;
    content: "";
    display: block;
  }
}

/*--ACCESSIBILITY--*/
.outscreen {
  height: 1px;
  left: -1000px;
  overflow: hidden;
  position: absolute;
  top: auto;
  width: 1px;
}

/*--CALLOUT--*/
.callout {
  border: 1px solid #eee;
  border-left-color: #777;
  border-left-width: 5px;
  border-radius: 3px;
  font-size: 0.9rem;
  padding: 20px;
  margin: 20px 0;
}

.author {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 0.8rem;
  margin-bottom: 1rem;
}

.author .name {
  line-height: 1rem;
  padding-top: 0.5rem;
}

.media,
.bd {
  overflow: hidden;
  _overflow: visible;
  
}

.media .img {
  float: left;
}

.avatar-img {
  border-radius: 100%;
  height: 3rem;
  margin-right: 0.5rem;
  width: 3rem;
}

/* SYNTAX HIGHLIGHTING */

code[class*="language-"],
pre[class*="language-"] {
  color: #393a34;
  font-family: "Consolas", "Bitstream Vera Sans Mono", "Courier New", Courier,
    monospace;
  direction: ltr;
  text-align: left;
  white-space: pre-wrap;
  word-spacing: normal;
  word-break: normal;
  font-size: 0.85em;
  line-height: 1.2em;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

pre[class*="language-"]::-moz-selection,
pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection,
code[class*="language-"] ::-moz-selection {
  background: #b3d4fc;
}

pre[class*="language-"]::selection,
pre[class*="language-"] ::selection,
code[class*="language-"]::selection,
code[class*="language-"] ::selection {
  background: #b3d4fc;
}

/* Code blocks */
pre[class*="language-"] {
  padding: 1em;
  margin: 0.5em 0;
  overflow: auto;
  border: 1px solid #dddddd;
  background-color: white;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: 0.2em;
  padding-top: 1px;
  padding-bottom: 1px;
  background: #f8f8f8;
  border: 1px solid #dddddd;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
  color: #999988;
  font-style: italic;
}

.token.namespace {
  opacity: 0.7;
}

.token.string,
.token.attr-value {
  color: #e3116c;
}
.token.punctuation,
.token.operator {
  color: #393a34; /* no highlight */
}

.token.entity,
.token.url,
.token.symbol,
.token.number,
.token.boolean,
.token.variable,
.token.constant,
.token.property,
.token.regex,
.token.inserted {
  color: #005cc5;
}

.token.keyword {
  color: #d73a49;
}

.token.atrule,
.token.attr-name {
  color: #6f42c1;
}

.token.function,
.token.deleted {
  color: #6f42c1;
}

.token.selector {
  color: #00009f;
}

.token.tag {
  color: #22863a;
}

.token.class-name {
  color: #6f42c1;
}

.token.important,
.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}

.caption,
figcaption {
  display: block;
  font-size: 0.8rem;
  text-align: center;
}

.codepen-aspect-ratio > iframe {
  height: 100%;
  position: absolute;
  width: 100%;
}

.twitter-tweet {
  margin-left: auto;
  margin-right: auto;
}

.twitter-tweet::after {
  content: "";
  display: block;
  padding-bottom: 20px;
  width: 100%;
}

.me {
  max-width: 22rem;
  margin: 0 auto 1rem;
  text-align: center;
}

.me > div {
  height: 8rem;
  margin: 0 auto;
  position: relative;
  width: 8rem;
}

.me svg {
  border-radius: 100%;
  height: 100%;
  left: 0;
  position: absolute;
  top: 0;
  width: 100%;
}

.me img {
  border-radius: 100%;
  height: 100%;
  position: relative;
  width: 100%;
}

.me h1 {
  font-size: 1.7rem;
  line-height: 2rem;
  margin-bottom: 0.5rem;
}

.read-next {
  background-color: #fdf6ea;
  margin: 2rem 0;
  padding: 1em;
}

@media (prefers-color-scheme: dark) {
  body {
    background: #38444c;
    color: #eee;
  }
  a {
    color: #9dcae8;
  }
  a:hover {
    color: #fff;
  }
  p a {
    border-bottom: 1px solid #6d7a82;
  }
  p a:hover {
    border-bottom: 1px solid #fff;
  }
  h1,
  h2,
  h3,
  h4,
  h5 {
    color: #eee;
  }
  a:hover h1,
  a:hover h2,
  a:hover h3,
  a:hover h4,
  a:hover h5 {
    color: #4b89b1;
  }
  .button:hover {
    background-color: #4b89b1;
  }
  code,
  pre {
    color: #ddd;
  }
  .main-header {
    background-color: #4b89b1;
  }
  .read-next {
    background-color: #020915;
  }
}

.amp-img-wrapper {
  position: absolute;
  height: 100%;
  width: 100%;
}
#hexo-amp-id-1{max-width:300px;display:block;margin-left:auto;margin-right:auto}#hexo-amp-id-2{text-align:center}
		
		amp-iframe {
			margin-bottom: 10px;
		}
	</style>
  </head>
  <body>

  	<!-- google analytics -->
  	

  <header class="main-header">
      <nav id="menu">
          <a href="/">JMPerez Blog</a>
          <a href="/projects/">Projects</a>
          <a href="/talks/">Speaking</a>
          <a href="/about-me/">About</a>
      </nav>
  </header>

  <article>
  	<div class="post">
	  	<div id="page">

		    <article id="post-2018/es/2018-04-06-high-performance-lazy-loading" class="post wrapper">

        <div class="media author">
          <div class="img">
            <a href="/about-me/">
              <amp-img src="/assets/images/jmperez.jpg" class="avatar-img" alt="" height="53" width="53">
            </a>
          </div>
          <div class="bd">
            <address class="name" itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/about-me/" itemprop="name">José M. Pérez</a></address>
            <meta class="post-data" itemprop="datePublished" content="2018-04-06T04:00:00.000Z">
              April 06 2018
            </meta>
          </div>
        </div>

				<!-- entry title -->
				<header class="entry-header">
					
					  <h1 class="article-title entry-title" itemprop="name">
					    Cómo mejorar la performance de una web usando lazy-loading y code-splitting
					  </h1>
					
				</header>

				<!-- entry content -->
			    <div class="entry-content ecp">
			  		<p>El desarrollo basado en componentes ha marcado un antes y un después en el desarrollo web. Las principales ventajas que suelen mencionarse son la reutilización y la modularización. Componentes bien definidos y encapsulados que podemos usar para construir nuestros sitios, como ladrillos de Legos. Una ventaja adicional es que esta estructura de componentes proporciona una base sólida para mejorar la performance de nuestras webs.</p>
<div class="amp-img-wrapper"><amp-img src="https://res.cloudinary.com/jmperez/image/upload/w_auto:100:684,f_auto/v1522995807/high-performance_mbjoct.jpg" width="700" height="365" layout="responsive"></amp-img></div>
<p>Nuestras dependencias son explícitas, por lo que sabemos qué código necesitamos ejecutar para cargar un componente específico. Lazy-loading y bundle-splitting pueden tener un gran impacto en el rendimiento de la página: requests con menos payload, código parseado y ejecutado. Y esto no solo se aplica a JavaScript, sino a cualquier tipo de asset.</p>
<p>Creo que muchas webs pueden aprovecharse de estas técnicas, y me gustaría mostrar algunos ejemplos básicos para solicitar recursos cuando sean necesarios.</p>
<span id="more"></span>

<p>En este post usaremos Preact/React, pero la idea se puede aplicar a cualquier otra librería basada en componentes.</p>
<p>Vamos a cubrir varios temas:</p>
<ol>
<li> <a href="#Patrones-de-composicion">Patrones de composición</a>: Descripción general de dos patrones que podemos usar para construir componentes complejos.</li>
<li> <a href="#Mejorando-el-rendimiento-de-nuestras-webs-cargando-solo-lo-necesario">Mejorando el rendimiento de nuestras webs cargando sólo lo necesario</a>: Un caso práctico donde aplicaremos lazy-loading.</li>
<li> <a href="#Un-pequeno-componente-para-detectar-cuando-una-area-es-visible">Un pequeño componente para detectar visibilidad</a>: Un componente sencillo que contiene la lógica para notificar cuándo aparece un elemento en la pantalla.</li>
<li> <a href="#Mas-casos-de-uso">Más casos de uso</a>: Veremos que un componente para detectar la visibilidad también puede ser útil en otras situaciones.</li>
<li> <a href="#Haciendo-polyfill-de-IntersectionObserver-bajo-demanda">Haciendo un polyfill de IntersectionObserver bajo demanda</a>: cómo podemos incluir un polyfill solo cuando sea necesario.</li>
<li> <a href="#Code-Splitting-y-CSS-in-JS">Code Splitting y CSS-in-JS</a>: cómo CSS-in-JS nos permite extender el code-splitting y lazy-loading a CSS, SVGs y otros recursos.</li>
<li> <a href="#Implementaciones-utiles">Implementaciones útiles</a>: librerías npm existentes que implementan el patrón que hemos explicado.</li>
</ol>
<p>¡Comencemos!</p>
<h2 id="Patrones-de-composicion"><a href="#Patrones-de-composicion" class="headerlink" title="Patrones de composición"></a>Patrones de composición</h2><p>En el desarrollo web basado en componentes éstos no se usan sólo para renderizar píxeles en la pantalla. También pueden encapsular una funcionalidad o comportamiento que se pasa a los componentes hijo.</p>
<p>Para esto se suelen utilizar <a href="https://reactjs.org/docs/higher-order-components.html">High Order Components (HOC)</a>. Estos componentes reciben otro componente y aumentan su funcionalidad.</p>
<p>Si has usado redux, la función <code>connect</code> es un HOC que recibe otro componente. Puedes encontrar más ejemplos en “<a href="https://medium.com/@franleplant/react-higher-order-components-in-depth-cf9032ee6c3e">React Higher Order Components in depth</a>“ de Fran Guijarro.</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">const</span> MyComponent <span class="token operator">=</span> props <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token entity" title="{">&amp;#123;</span>props<span class="token punctuation">.</span>id<span class="token entity" title="}">&amp;#125;</span> <span class="token operator">-</span> <span class="token entity" title="{">&amp;#123;</span>props<span class="token punctuation">.</span>name<span class="token entity" title="}">&amp;#125;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token keyword">const</span> ConnectedComponent <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>
  mapStateToProps<span class="token punctuation">,</span>
  mapDispatchToProps
<span class="token punctuation">)</span><span class="token punctuation">(</span>MyComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Function as Child Component (también llamado “<a href="https://reactpatterns.com/#render-callback">Render Callback</a>“) es otro patrón que se usa en situaciones similares. Cada vez es más popular, y puede que lo hayas visto en librerías como <a href="https://github.com/ReactTraining/react-media">react-media</a> o <a href="https://github.com/jamiebuilds/unstated">unstated</a>.</p>
<p>Veamos este ejemplo tomado de react-media:</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">const</span> MyComponent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Media</span> <span class="token attr-name">query</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(max-width:</span> <span class="token attr-name">599px)"</span><span class="token punctuation">&gt;</span></span>
    <span class="token entity" title="{">&amp;#123;</span>matches <span class="token operator">=</span><span class="token operator">&gt;</span>
      matches <span class="token operator">?</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>The document is less than 600px wide<span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>The document is at least 600px wide<span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token punctuation">)</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Media</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>El componente <code>Media</code> llama a sus hijos pasando un argumento <code>matches</code>. De esta forma los componentes hijos no necesitan saber sobre la media query. La componentización suele hacer más fácil el testeo y mantenimiento del código.</p>
<h2 id="Mejorando-el-rendimiento-de-nuestras-webs-cargando-solo-lo-necesario"><a href="#Mejorando-el-rendimiento-de-nuestras-webs-cargando-solo-lo-necesario" class="headerlink" title="Mejorando el rendimiento de nuestras webs cargando sólo lo necesario"></a>Mejorando el rendimiento de nuestras webs cargando sólo lo necesario</h2><p>Imagina una página web típica. Puedes echar un ojo a <a href="https://css-tricks.com/website-sameness/">Website Sameness</a> o <a href="https://www.friday.ie/journal/why-do-all-websites-look-the-same/">Web Design Trends: Why Do All Websites Look The Same?</a> para más inspiración :) . La página de ejemplo que vamos a usar contiene varias secciones o bloques:</p>
<ul>
<li>una cabecera (estos días, una imagen grande o “hero image” que ocupa toda el área por encima del fold)</li>
<li>una sección con algunas imágenes</li>
<li>otra sección con un componente pesado como un mapa</li>
<li>un footer</li>
</ul>
<p id="hexo-amp-id-1">
</p><div class="amp-img-wrapper"><amp-img src="https://res.cloudinary.com/jmperez/image/upload/w_auto:100:300,f_auto/v1523084060/observer/site.png" width="300" height="489" layout="responsive"></amp-img></div>
<small class="caption">La estructura básica de una página que estaremos usando como ejemplo.</small>


<p>Mapeado a componentes React sería algo como esto:</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">const</span> Page <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Header</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Gallery</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Map</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Footer</span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
</code></pre>
<p>Cuando el usuario visita la página, es muy probable que vea la cabecera en la pantalla. Es menos probable que vea la galería, el mapa y el pie de página, a menos que haga scroll.</p>
<p>Seguramente sueles incluir todos los scripts y CSS necesarios para renderizar todas las secciones cuando el usuario carga la página. Hasta hace poco, era difícil definir las dependencias de un módulo y cargar sólo lo que se necesitaba.</p>
<p>Hace años, antes de ES6, algunas empresas con webs grandes crearon soluciones propias para definir dependencias y cargarlas bajo demanda. Yahoo creó <a href="https://books.google.com/books?id=E7p-07kNfXYC&amp;pg=PA65&amp;lpg=PA65&amp;dq=yahoo+yui+loader&amp;source=bl&amp;ots=UOcpQHdaRp&amp;sig=AGTHNZvPYXWdU9lkj9klzTEa3ys&amp;hl=en&amp;sa=X&amp;ved=0ahUKEwjn26Wti8PZAhUJDSwKHQOsCbIQ6AEIVDAG#v=onepage&amp;q=yahoo%20yui%20loader&amp;f=false">YUI Loader</a> y Facebook hizo lo propio con <a href="/facebook-frontend-javascript/">Haste, Bootloader y Primer</a>.</p>
<p>Cuando envías código innecesario al usuario se desperdician tus recursos y los suyos. Más ancho de banda para transferir los datos, más CPU para parsearlos y ejecutarlos, y más memoria utilizada. Y esos assets robarán los recursos limitados de otros assets críticos que lo necesitan con más urgencia.</p>
<p>¿De qué sirve hacer peticiones innecesarias, como imágenes que el usuario nunca verá? ¿O cargar un componente de terceros como un mapa de Google, con todas sus peticiones adicionales necesarias para procesar?</p>
<p>Un informe de cobertura de código, como <a href="https://developers.google.com/web/updates/2017/04/devtools-release-notes#coverage">el que proporciona Google Chrome</a> <strong>no nos será de mucha ayuda</strong>. El código JS será ejecutado y el CSS aplicado a elementos que no están visibles.</p>
<div class="amp-img-wrapper"><amp-img src="https://res.cloudinary.com/jmperez/image/upload/w_auto:100:684,f_auto/v1522995652/observer/chrome-coverage.png" width="700" height="492" layout="responsive"></amp-img></div>
<p><small class="caption">Pestaña de cobertura de código en Google Chrome (<a href="https://developers.google.com/web/updates/2017/04/devtools-release-notes#coverage">fuente</a>)</small></p>
<p>Como en todo, <strong>hay pros y contras cuando se usa lazy-loading</strong>. No queremos aplicar lazy-loading a todos los elementos. Debemos tener en cuenta algunas cosas.</p>
<ul>
<li><strong>No usar lazy-loading por encima del fold</strong>. En la mayoría de casos queremos que el contenido por encima del fold se renderice tan pronto como sea posible. Todas las técnicas de lazy-loading introducen un retraso. El navegador tiene que ejecutar el JS que inyecta el HTML en el documento, parsearlo y comenzar a pedir los assets referenciados.</li>
</ul>
<div class="amp-img-wrapper"><amp-img src="https://res.cloudinary.com/jmperez/image/upload/w_auto:100:684,f_auto/v1522995652/observer/fold.png" width="700" height="434" layout="responsive"></amp-img></div>

<p>¿Cómo sabemos dónde queda el fold? La verdad es que es difícil y depende del dispositivo del usuario y de tu layout.</p>
<ul>
<li><strong>Si usas lazy-loading, carga los elementos un poco antes de cuando se necesitan</strong>. Es buena idea evitar mostrar áreas vacías en tu web. Para ello, puedes cargar un elemento cuando esté lo suficientemente cerca del área visible. Por ejemplo, cuando el usuario hace scroll hacia abajo y la imagen a cargar está 100px más abajo, empieza a solicitarla.</li>
</ul>
<div class="amp-img-wrapper"><amp-img src="https://res.cloudinary.com/jmperez/image/upload/w_auto:100:684,f_auto/v1522995652/observer/preloading.png" width="700" height="434" layout="responsive"></amp-img></div>

<ul>
<li><p>**Contenido invisible en algunos casos**. Debes tener en cuenta que el contenido cargado usando lazy-loading no se mostrará en estas situaciones:</p>
 - Si el contenido cargado lazy-loading no se ha cargado no se mostrará al intentar imprimir la página.
 - Lo mismo ocurre cuando la página se muestra en lectores RSS que no ejecuten el JS necesario para cargar el contenido.
 - Puedes tener problemas con SEO al indexar contenido cargado con lazy-loading en Google. En el momento de escribir este artículo, Googlebot soporta IntersectionObserver e invoca su callback con cambios en el viewport por encima del fold. Sin embargo, **no invoca el callback para contenido por debajo del fold**. Por lo tanto, **ese contenido no será visto ni indexado por Google**.
   Si tu contenido es importante puedes renderizar el texto y dejar lazy-loading para componentes como imágenes y otros widgets (por ejemplo mapas).

<p>Aquí estoy cargando <a href="https://jmperezperez.com/lazy-load/89b6f20e1d79e9fb902242ab84217b12.html">una página de test</a> (puedes ver el código fuente <a href="https://github.com/JMPerez/lazy-load/blob/master/text-above-fold.js">aquí</a>) usando la función “Fetch as Google” de Google Webmaster Tools. Googlebot renderiza el contenido que queda dentro del viewport, pero no el que se cargaría debajo.</p>
<div class="videoWrapper">
  <amp-youtube data-videoid="YEWaufLXX" width="1920" height="1080" layout="responsive"></amp-youtube>
</div>
<small class="caption">Renderizando [una página de prueba](https://jmperezperez.com/lazy-load/89b6f20e1d79e9fb902242ab84217b12.html) usando "Fetch as Google" de Google Webmaster Tools.</small></li>
</ul>
<div class="callout">
<strong>Actualización a 10 de mayo de 2019</strong>: Google anunció durante el I/O 2019 que <a href="https://webmasters.googleblog.com/2019/05/the-new-evergreen-googlebot.html">actualizarán Googlebot para usar la última versión de Chrome</a>. Esto acaba con el problema de que Googlebot use Chrome 41 para renderizar páginas, y añade soporte para IntersectionObserver. Si utilizas Google Search Console para comprobar cómo Google renderiza una de tus URLs, todavía recibirás el resultado de renderizar usando Chrome 41. Esto es porque <a href="https://youtu.be/Ey0N1Ry0BPM?t=381">Google aún no ha actualizado sus herramientas de testeo para utilizar un Chrome <em>evergreen</em>.
</a></div><a href="https://youtu.be/Ey0N1Ry0BPM?t=381">

</a><h2 id="Un-pequeno-componente-para-detectar-cuando-una-area-es-visible"><a href="https://youtu.be/Ey0N1Ry0BPM?t=381"></a><a href="#Un-pequeno-componente-para-detectar-cuando-una-area-es-visible" class="headerlink" title="Un pequeño componente para detectar cuando una área es visible"></a>Un pequeño componente para detectar cuando una área es visible</h2><p>En el pasado hablé sobre <a href="/lazy-loading-images/">lazy-load de imágenes</a>. La misma técnica se puede aplicar a otros elemetos.</p>
<p>Vamos a escribir un componente sencillo que detectará cuando una sección es visible en el viewport. Para hacerlo más breve usaré la <a href="https://developer.mozilla.org/docs/Web/API/Intersection_Observer_API">Intersection Observer API</a>, una tecnología experimental con <a href="https://caniuse.com/#search=intersectionobserver">bastante buen soporte</a>.</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token entity" title="{">&amp;#123;</span> isVisible<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span><span class="token punctuation">[</span>entry<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token entity" title="{">&amp;#123;</span> isVisible<span class="token punctuation">:</span> entry<span class="token punctuation">.</span>isIntersecting <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">,</span> <span class="token entity" title="{">&amp;#123;</span><span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token comment">// creamos un div para obtener una referencia.</span>
      <span class="token comment">// Es posible usar findDOMNode() para evitar</span>
      <span class="token comment">// crear elementos extras, pero findDOMNode está desaconsejado</span>
      <span class="token operator">&lt;</span>div
        ref<span class="token operator">=</span><span class="token entity" title="{">&amp;#123;</span>div <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> div<span class="token punctuation">;</span>
        <span class="token entity" title="}">&amp;#125;</span><span class="token entity" title="}">&amp;#125;</span>
      <span class="token operator">&gt;</span>
        <span class="token entity" title="{">&amp;#123;</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
          <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>child <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">child</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
<span class="token entity" title="}">&amp;#125;</span>
</code></pre>
<p>El componente usa IntersectionObserver para detectar si el contenedor intersecta con el viewport, es decir, si está visible. Aprovechamos los métodos del lifecycle de React para limpiar el IntersectionObserver <a href="https://developer.mozilla.org/docs/Web/API/IntersectionObserver/disconnect">desconectándolo</a> al desmontar.</p>
<p>Este componente básico puede extenderse con propiedades adicionales pasadas como <a href="https://developer.mozilla.org/docs/Web/API/Intersection_Observer_API#Intersection_observer_options">opciones para el IntersectionObserver</a> como márgenes o umbrales. Así, podríamos detectar elementos cercanos pero que no intersectan con el viewport. Las opciones se establecen en el constructor y son de sólo lectura. Añadir soporte para opciones requeriría reinstanciar el IntersectionObserver con nuevas opciones cuando cambien, añadiendo lógica extra en <code>componentWillReceiveProps</code> que no vamos a cubrir aquí.</p>
<p>Podemos usar este componente para hacer lazy-loading de dos de nuestros componentes, <code>Gallery</code> y <code>Map</code>:</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">const</span> Page <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Header</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Observer</span><span class="token punctuation">&gt;</span></span><span class="token entity" title="{">&amp;#123;</span>isVisible <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Gallery</span> <span class="token attr-name">isVisible</span> <span class="token punctuation">/&gt;</span></span><span class="token entity" title="}">&amp;#125;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Observer</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Observer</span><span class="token punctuation">&gt;</span></span><span class="token entity" title="{">&amp;#123;</span>isVisible <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Map</span> <span class="token attr-name">isVisible</span> <span class="token punctuation">/&gt;</span></span><span class="token entity" title="}">&amp;#125;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Observer</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Footer</span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
</code></pre>
<p>En el código anterior paso la propiedad <code>isVisible</code> a los componentes <code>Gallery</code> y <code>Map</code> para que ellos la gestionen. Otra forma de hacerlo es devolver el componente si está visible, o un elemento vacío en caso contrario.</p>
<p>En cualquier caso <strong>asegúrate de que reservas el área para el componente</strong>. No es buena idea que el contenido “salte” cuando el componente se carga, así que si sabes que tu <code>Map</code> tiene un alto de 400px, renderiza un contenedor vacío de 400px de altura antes de que el mapa se cargue.</p>
<p>¿Cómo usan los componentes <code>Map</code> y <code>Gallery</code> la propiedad <code>isVisible</code>? Veamos el componente <code>Map</code>:</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Map</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token entity" title="{">&amp;#123;</span> initialized<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>map <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>

  <span class="token function">initializeMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token entity" title="{">&amp;#123;</span> initialized<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// loadScript carga un script externo, su definición no se incluye aquí.</span>
    <span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token string">'https://maps.google.com/maps/api/js?key=&lt;your_key&gt;'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">const</span> latlng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">google<span class="token punctuation">.</span>maps<span class="token punctuation">.</span>LatLng</span><span class="token punctuation">(</span><span class="token number">38.34</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> myOptions <span class="token operator">=</span> <span class="token entity" title="{">&amp;#123;</span> zoom<span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span> center<span class="token punctuation">:</span> latlng <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">google<span class="token punctuation">.</span>maps<span class="token punctuation">.</span>Map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">,</span> myOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initializeMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token entity" title="}">&amp;#125;</span>

  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>initialized <span class="token operator">&amp;&amp;</span> nextProps<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initializeMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token entity" title="}">&amp;#125;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div
        ref<span class="token operator">=</span><span class="token entity" title="{">&amp;#123;</span>div <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>map <span class="token operator">=</span> div<span class="token punctuation">;</span>
        <span class="token entity" title="}">&amp;#125;</span><span class="token entity" title="}">&amp;#125;</span>
      <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
<span class="token entity" title="}">&amp;#125;</span>
</code></pre>
<p>Cuando se muestra el contenedor en el viewport, hacemos una petición para inyectar el script de Google Maps, y una vez cargado instanciamos el mapa. Éste es un buen ejemplo de código JavaScript que no se necesita al principio y podemos cargar bajo demanda, y por consiguiente el resto de recursos necesarios para mostrar el mapa.</p>
<p>El componente tiene estado propio para evitar volver a inyectar el script de Google Maps.</p>
<p>Veamos el componente <code>Gallery</code>:</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Gallery</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token entity" title="{">&amp;#123;</span> hasBeenVisible<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token entity" title="{">&amp;#123;</span> hasBeenVisible<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasBeenVisible <span class="token operator">&amp;&amp;</span> nextProps<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token entity" title="{">&amp;#123;</span> hasBeenVisible<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Some pictures<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        Picture <span class="token number">1</span><span class="token entity" title="{">&amp;#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasBeenVisible <span class="token operator">?</span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://example.com/image01.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>placeholder<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span>
        Picture <span class="token number">2</span>
        <span class="token entity" title="{">&amp;#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasBeenVisible <span class="token operator">?</span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://example.com/image02.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>placeholder<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
<span class="token entity" title="}">&amp;#125;</span>
</code></pre>
<p>El ejemplo anterior define otro componente con estado. De hecho, estamos almacenando en el estado la misma información que almacena <code>Map</code>.</p>
<p>Si la galería se muestra dentro del viewport y más tarde el usuario hace scroll y la galería deja de estar visible, las imágenes permanecerán en el DOM. En la mayoría de los casos, esto es lo que queremos cuando trabajamos con imágenes.</p>
<h3 id="Componentes-hijo-sin-estado"><a href="#Componentes-hijo-sin-estado" class="headerlink" title="Componentes hijo sin estado"></a>Componentes hijo sin estado</h3><p>Un componente sin estado (stateless) también resulta interesante. Nos permitiría quitar de la memoria las imágenes que ya no estén visibles, mostrando placeholders:</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">const</span> Gallery <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token entity" title="{">&amp;#123;</span> isVisible <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Some pictures<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    Picture <span class="token number">1</span><span class="token entity" title="{">&amp;#123;</span>isVisible <span class="token operator">?</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://example.com/image01.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>placeholder<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span>
    Picture <span class="token number">2</span>
    <span class="token entity" title="{">&amp;#123;</span>isVisible <span class="token operator">?</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://example.com/image02.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>placeholder<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Si haces esto, <strong>asegúrate de que las imágenes tienen las cabeceras de respuesta adecuadas</strong> para que las peticiones subsecuentes usen la caché y no descarguen las imágenes otra vez.</p>
<p>Puedes mover la lógica al componente <code>Observer</code> si ves que creas componentes con estado sólo para almacenar si se han mostrado al menos una vez. <code>Observer</code> ya tiene estado y puede llamar a sus hijos fácilmente con un argumento adicional <code>hasBeenVisible</code>.</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">const</span> Page <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token operator">...</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Observer</span><span class="token punctuation">&gt;</span></span>
    <span class="token entity" title="{">&amp;#123;</span><span class="token punctuation">(</span>isVisible<span class="token punctuation">,</span> hasBeenVisible<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Gallery</span> <span class="token attr-name">hasBeenVisible</span> <span class="token punctuation">/&gt;</span></span> <span class="token comment">// Gallery ya no necesita estado</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Observer</span><span class="token punctuation">&gt;</span></span>
  <span class="token operator">...</span>
<span class="token entity" title="}">&amp;#125;</span>
</code></pre>
<p>Otra opción es tener una variación del componente <code>Observer</code> que sólo pase una prop como <code>hasBeenVisible</code>. Esto tiene la ventaja de que podemos desconectar el IntersectionObserver tan pronto como el elemento se muestre, ya que no vamos a cambiar su valor. Llamaremos a este componente <code>ObserverOnce</code>:</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">ObserverOnce</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token entity" title="{">&amp;#123;</span> hasBeenVisible<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>entries <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
      entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>isIntersecting<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token entity" title="{">&amp;#123;</span> hasBeenVisible<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token entity" title="}">&amp;#125;</span>
      <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">,</span> <span class="token entity" title="{">&amp;#123;</span><span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div
        ref<span class="token operator">=</span><span class="token entity" title="{">&amp;#123;</span>div <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> div<span class="token punctuation">;</span>
        <span class="token entity" title="}">&amp;#125;</span><span class="token entity" title="}">&amp;#125;</span>
      <span class="token operator">&gt;</span>
        <span class="token entity" title="{">&amp;#123;</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
          <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>child <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">child</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasBeenVisible<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasBeenVisible<span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
<span class="token entity" title="}">&amp;#125;</span>
</code></pre>
<h2 id="Mas-casos-de-uso"><a href="#Mas-casos-de-uso" class="headerlink" title="Más casos de uso"></a>Más casos de uso</h2><p>Hemos utilizado el componente <code>Observer</code> para cargar recursos bajo demanda. También lo podemos utilizar para comenzar la animación de un componente cuando se muestre en pantalla.</p>
<p>En este ejemplo tomado de la web de React Alicante se animan unas cifras cuando el usuario hace scroll hasta esa sección.</p>
<div id="hexo-amp-id-2">
  <amp-video width="1064" height="618" controls="" src="https://res.cloudinary.com/jmperez/video/upload/dpr_auto,f_auto,q_auto/v1522995652/observer/react-alicante.mp4" layout="responsive">
</amp-video></div>

<p>Podemos recrearlo con este código (puedes verlo y editarlo <a href="https://codepen.io/jmperez/pen/LQXjYv">en Codepen</a>):</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">ConferenceData</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token entity" title="{">&amp;#123;</span> progress<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>interval <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>animationDuration <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>startAnimation <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>isVisible <span class="token operator">&amp;&amp;</span>
      nextProps<span class="token punctuation">.</span>isVisible <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>progress <span class="token operator">!==</span> <span class="token number">1</span>
    <span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>startAnimation <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> tick <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
        <span class="token keyword">const</span> progress <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
          <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startAnimation<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>animationDuration
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token entity" title="{">&amp;#123;</span> progress<span class="token punctuation">:</span> progress <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>progress <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
          <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>tick<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token entity" title="}">&amp;#125;</span>
      <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
      <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token entity" title="{">&amp;#123;</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>progress <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span> days ·
        <span class="token entity" title="{">&amp;#123;</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>progress <span class="token operator">*</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span> talks ·
        <span class="token entity" title="{">&amp;#123;</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>progress <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span> workshops ·
        <span class="token entity" title="{">&amp;#123;</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>progress <span class="token operator">*</span> <span class="token number">350</span><span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span> attendees
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
<span class="token entity" title="}">&amp;#125;</span>
</code></pre>
<p>Una vez definido podemos utilizarlo de la misma forma que el resto de componentes. Esta es una muestra del potencial de abstraer la lógica para detectar la visibilidad fuera de los componentes que la necesitan.</p>
<h2 id="Haciendo-polyfill-de-IntersectionObserver-bajo-demanda"><a href="#Haciendo-polyfill-de-IntersectionObserver-bajo-demanda" class="headerlink" title="Haciendo polyfill de IntersectionObserver bajo demanda"></a>Haciendo polyfill de IntersectionObserver bajo demanda</h2><p>Hasta ahora hemos utilizado IntersectionObserver para detectar cuándo un elemento se muestra en pantalla. En el momento de escribir este artículo algunos navegadores, como Safari, no soportan IntersecionObserver. Si lo intentamos instanciar el navegador lanzará un error.</p>
<p>Podríamos establecer <code>isVisible</code> a <code>true</code> cuando IntersectionObserver no esté disponible, lo que en la práctica desactivaría el lazy-loading. En cierta manera consideraríamos lazy-loading como un progressive enhancement:</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// isVisible se inicializa a true si el</span>
    <span class="token comment">// navegador no soporta IntersectionObserver</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> isVisible<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>IntersectionObserver<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment">// sólo inicializamos IntersectionObserver si está soportado</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>IntersectionObserver<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>entries <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token operator">...</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>Mi opción favorita es incluir un polyfill como el <a href="https://github.com/w3c/IntersectionObserver/tree/master/polyfill">polyfill para IntersectionObserver de w3c</a>. Así, IntersectionObserver funciona en todos los navegadores.</p>
<p>Como estamos hablando de cargar assets bajo demanda, qué mejor que aplicarlo a este caso. Usaremos code-splitting para hacer la petición del polyfill sólo si nos hace falta, es decir, si el navegador no tiene soporte para IntersectionObserver:</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span>window<span class="token punctuation">.</span>IntersectionObserver
      <span class="token operator">?</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">:</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'intersection-observer'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>IntersectionObserver</span><span class="token punctuation">(</span>entries <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> isVisible<span class="token punctuation">:</span> entry<span class="token punctuation">.</span>isIntersecting <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>Puedes ver <a href="https://react-intersection-observer.stackblitz.io/">una demostración aquí</a> (<a href="https://stackblitz.com/edit/react-intersection-observer">código fuente</a>). Safari hará una petición extra para cargar el paquete npm <code>intersection-observer</code> dado que no soporta IntersectionObserver.</p>
<div class="amp-img-wrapper"><amp-img src="https://res.cloudinary.com/jmperez/image/upload/w_auto:100:684,f_auto/v1522995652/observer/safari-intersection-observer-2.jpg" width="700" height="442" layout="responsive"></amp-img></div>

<p><small class="caption">Safari hace una request para el polyfill de intersection-observer bajo demanda. No necesitamos cargarlo en navegadores que lo soportan nativamente.</small></p>
<p>La solución se basa en code splitting. Hay herramientas como <a href="https://parceljs.org/code_splitting.html">Parcel</a> o <a href="https://webpack.js.org/guides/code-splitting/">Webpack</a> que crearán un bundle para ese paquete importado, así como la lógica para hacer la petición para ese fichero.</p>
<h2 id="Code-Splitting-y-CSS-in-JS"><a href="#Code-Splitting-y-CSS-in-JS" class="headerlink" title="Code Splitting y CSS-in-JS"></a>Code Splitting y CSS-in-JS</h2><p>Hasta ahora hemos visto cómo usar un HOC para detectar que un elemento está en el viewport. También hemos aprendido cómo cargar JavaScript adicional cuando hace falta.</p>
<p>Code-splitting es bastante común y fácil de implementar a nivel de ruta. El navegador carga bundles adicionales cuando el usuario va navegando a través de diferentes URLs de la web. Herramientas como <a href="https://github.com/ReactTraining/react-router">react-router</a> y <a href="https://github.com/zeit/next.js/">Next.js</a> han popularizado code-splitting, integrándolo como parte de dynamic imports.</p>
<p>A través de varios ejemplos hemos visto que se puede implementar code-splitting dentro de una misma ruta, cargando el código para los componentes bajo demanda. Esto es muy útil si tenemos componentes que necesitan mucho código específico, no sólo JavaScript.</p>
<p>Un componente puede referenciar otros recursos o incluso contenerlos “inline”. Un ejemplo son SVGs o estilos CSS.</p>
<p>No tiene sentido solicitar estilos que no se van a aplicar a ningún elemento. Solicitar estilos e inyectarlos dinámicamente causa un FOUC (Flash of Unstyled Content). El navegador muestra los elementos HTML con el estilo existente, y una vez que los estilos adicionales son inyectados re-estila el contenido. Con la aparición de soluciones CSS-in-KS (o JSS) esto ya no es un problema. El CSS se incluye inline en el componente, y conseguimos code-splitting verdadero para nuestros componentes. <strong>Con CSS-in-JS llevamos code-splitting más allá, cargando CSS bajo demanda.</strong></p>
<h2 id="Implementaciones-utiles"><a href="#Implementaciones-utiles" class="headerlink" title="Implementaciones útiles"></a>Implementaciones útiles</h2><p>En este post he explicado cómo implementar un componente Observer básico. Existing implementaciones de componentes similares que han sido probadas en muchas aplicaciones y soportan más opciones y formas de integrarse en tu proyecto.</p>
<p>Recomiendo echar un vistazo a estas dos librerías:</p>
<ul>
<li><a href="https://github.com/thebuilder/react-intersection-observer">thebuilder/react-intersection-observer</a></li>
<li><a href="https://github.com/researchgate/react-intersection-observer">researchgate/react-intersection-observer</a></li>
</ul>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusión"></a>Conclusión</h2><p>La componentización hace el code-splitting y la carga de recursos bajo demanda más fácil que nunca. Define las dependencias de tu código y usa los bundlers y otras herramientas modernas para hacer peticiones para las dependencias cuando el usuario navegue a nuevas rutas o se muestren nuevos componentes en la página.</p>
<hr>
<p>Me gustaría dar las gracias a <a href="https://twitter.com/alexjoverm">@alexjoverm</a>, <a href="https://twitter.com/aarongarciah">@aarongarciah</a> y <a href="https://twitter.com/FlavioCorpa">@FlavioCorpa</a> por revisar este artículo, investigar lazy-loading desde varios puntos de vista, y recomendar herramientas para crear los ejemplos.</p>
<p>Si encuentras alguna errata o información errónea, <a href="https://twitter.com/jmperezperez">no dudes en escribirme</a>.</p>

			  	</div>

		  	</article>
		</div>
    <footer>
        <section class="links">
            <a href="https://twitter.com/jmperezperez">@jmperezperez</a> on Twitter · <a href="https://github.com/JMPerez">GitHub</a> · <a href="http://www.linkedin.com/in/jmperezperez">LinkedIn</a>
        </section>
    </footer>

	</div>
  </article>

  </body>
</html>
