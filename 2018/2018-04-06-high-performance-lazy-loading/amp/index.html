<!doctype html>
<html ⚡>
  <head>
    <meta charset="utf-8">
    <link rel="canonical" href="https://jmperezperez.com//high-performance-lazy-loading" >
    <title>Increase the Performance of your Site with Lazy-Loading and Code-Splitting - Web development, performance, and some other good practices.</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
		<meta name="twitter:card" content="summary_large_image">
		<meta name="twitter:title" content="Increase the Performance of your Site with Lazy-Loading and Code-Splitting - José M. Pérez" property="og:title">
		<meta name="twitter:description" content="Using a High Order Component to detect visibility and lazy-load components and sections on our pages. Just serve what is needed." property="og:description">
		<meta name="twitter:site" content="@jmperezperez">
		
		<meta property="og:image" content="https://jmperezperez.com/assets/images/posts/observer/high-performance.jpg">
		<meta name="twitter:image" content="https://jmperezperez.com/assets/images/posts/observer/high-performance.jpg">
		
    <noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    
    <script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script>
    
    <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
    

    <script async src="https://cdn.ampproject.org/v0.js"></script>
    <script type="application/ld+json">
		{
			"@context": "http://schema.org",
			"@type": "BlogPosting",
			"headline": "Increase the Performance of your Site with Lazy-Loading and Code-Splitting",
			
			"description": "Using a High Order Component to detect visibility and lazy-load components and sections on our pages. Just serve what is needed.",
			
			"mainEntityOfPage":{
			    "@type":"WebPage",
			    "@id":"/high-performance-lazy-loading"
			},
			"datePublished": "2018-04-06T04:00:00.000Z",
			"dateModified": "2021-12-14T07:52:53.533Z",
			
			"image": {
				"@type": "ImageObject",
				"url": "https://res.cloudinary.com/jmperez/image/upload/w_auto:100:684,f_auto/v1522995807/high-performance_mbjoct.jpg",
				"width" : "700",
				"height" : "365"
			},
			
			"author": {
			    "@type": "Person",
			    "name": "Jose M. Perez"
			},
			"publisher": {
			    "@type": "Organization",
			    "name": "Jose M. Perez&#39;s Blog"
			    
			    ,
			    "logo": {
			      "@type": "ImageObject",
			      "url": "https://jmperezperez.com/amp-dist/logo.png",
			      "width": 600,
			      "height": 60
			    }
			    
			}
		}
	</script>
	<style amp-custom>
		
			/*--RESET--*/
* {
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  border: none;
  font: inherit;
  margin: 0;
  padding: 0;
  vertical-align: baseline;
}

input,
button {
  background: none;
}

html {
  font-size: 18px;
}

@media (max-width: 768px) {
  html {
    font-size: 16px;
  }
}

/*--BODY--*/

body {
  background: #fff;
  color: #555;
  font-family: Georgia, Times;
  font-weight: 300;
  font-style: normal;
  line-height: 1.5rem;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-text-size-adjust: 100%; /* fixes a too large font issue in horizontally scrollable <pre> on webkit */
}

h1,
h2,
h3,
h4,
h5 {
  color: #212121;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-weight: 600;
  line-height: 2rem;
  margin-bottom: 1.5rem;
}

#menu a,
.button {
  font-size: 1em;
  font-weight: 400;
}

p,
.post ul,
.post ol,
iframe,
video,
amp-video,
amp-vimeo,
amp-youtube {
  margin: 0;
  margin-bottom: 1rem;
}

twitterwidget {
  margin-bottom: 1em ;
}

a {
  color: #2a7cb2;
  font-weight: inherit;
  text-decoration: none;
  transition: color 0.15s ease-out, border-bottom-color 0.15s ease-out;
}

a:hover {
  color: #2a7cb2;
}

abbr {
  border-bottom: 1px dashed #ccc;
  text-decoration: none;
}

p a {
  border-bottom: 1px solid #eee;
}

p a:hover {
  border-bottom-color: #212121;
}

strong {
  font-weight: bold;
}

em {
  font-style: italic;
}

h1 {
  font-size: 1.7rem;
}

h2 {
  color: #444;
  display: inline-block;
  font-size: 1.6rem;
  font-weight: 400;
  margin-top: 1rem;
}

h3 {
  color: #666;
  display: inline-block;
  font-size: 1.4rem;
  font-weight: 400;
  margin-top: 1rem;
}

h4 {
  font-size: 1.18rem;
}

h5 {
  font-size: 1rem;
}

a h1,
a h2,
a h3,
a h4,
a h5 {
  transition: color 0.15s ease-out;
}

a:hover h1,
a:hover h2,
a:hover h3,
a:hover h4,
a:hover h5 {
  color: #3498db;
}

.quote {
  margin: 0 0 15px 0;
}

blockquote {
  border-left: 2px solid #ccc;
  font-style: italic;
  margin: 0 0 15px 0;
  padding-left: 20px;
}

ul,
ol {
  margin: 0 0 15px 0;
  padding-left: 25px;
}

ul {
  list-style: square;
}

ol {
  list-style: decimal;
}

hr {
  background: #eee;
  color: #eee;
  clear: both;
  display: block;
  height: 2px;
  margin: 30px auto;
  width: 50%;
}

pre,
code {
  color: #333;
  font-family: Courier, Menlo, Monaco;
  font-size: 0.8em;
  letter-spacing: 0px;
  overflow-x: auto;
}

pre {
  padding: 0.8em 1em;
  white-space: pre-wrap;
}

code {
  margin: 0;
}

/*--CLEARFIXES--*/

.post::after {
  display: block;
  clear: both;
  content: "";
}

/*--HEADER--*/

.main-header {
  background-color: #005689;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  overflow: hidden;
  margin-bottom: 1.5rem;
  padding: 1rem;
  position: relative;
  text-align: center;
  width: 100%;
}

/*--MENU--*/

#menu {
  display: inline-block;
  line-height: 2rem;
}

#menu a {
  color: #fff;
  font-size: 0.9rem;
  margin-left: 1rem;
  padding: 1rem 0.5rem;
  text-transform: uppercase;
}

@media (max-width: 500px) {
  #menu a {
    margin-left: 0.5rem;
    padding: 0.5rem 0.25rem;
  }
}

#menu a:first-child {
  margin-left: 0;
}

#menu a[aria-current] {
  font-weight: bold;
}

/*--PAGE--*/

#page {
  margin: 0 auto;
  max-width: 41rem;
  padding-left: 1.5rem;
  padding-right: 1.5rem;
  position: relative;
}

.videoWrapper {
  height: 0;
  margin-bottom: 1em;
  padding-bottom: 56.25%; /* 16:9 */
  padding-top: 25px;
  position: relative;
}

.videoWrapper iframe,
.videoWrapper amp-youtube {
  height: 100%;
  left: 0;
  position: absolute;
  top: 0;
  width: 100%;
}

/*--WRAPPER--*/

.wrapper {
  border-top: 2px solid #eee;
  padding-top: 2rem;
}

.wrapper:first-child {
  border-top: none;
  padding-top: 1rem;
}

.posts-list h2 {
  margin-top: 0;
}

/*--POSTS--*/

.post {
  display: block;
  margin-bottom: 2rem;
  width: 100%;
}

.post div[itemprop="articleBody"] > p:first-child {
  color: #333;
}

.post li {
  margin-bottom: 0.5rem;
}

.post p + img {
  margin-bottom: 1rem;
}

.post p img {
  border: 1px solid #eee;
  display: block;
  max-width: 100%;
}

.post img + .caption,
.post img + figcaption {
  padding-top: 0.5rem;
}

.post .svg-container {
  margin-bottom: 5%;
  max-width: 100%;
  text-align: center;
}

figure {
  padding-bottom: 1em;
}

video {
  height: auto;
  max-width: 100%;
}

.post .svg-container object {
  width: 100%;
}

.tag-list {
  display: inline-block;
  list-style-type: none;
  margin: 0;
  padding: 0;
  padding-bottom: 1rem;
}

.tag-list-item {
  display: inline-block;
  margin-left: 0.8em;
}

/*--PAGINATION--*/

.pagination {
  padding-bottom: 1rem;
  text-align: center;
}

.pagination a {
  min-width: 30px;
  max-height: 30px;
  text-align: center;
}

/*--FOOTER--*/

footer {
  border-top: 1px dashed #ddd;
  padding: 2em;
  text-align: center;
}

.timing-stats {
  font-size: 0.7em;
  padding: 0.35em;
}

/*--BUTTONS--*/

.button {
  background-color: #fff;
  border: 1px solid #555;
  border-radius: 2rem;
  color: #555;
  display: inline-block;
  padding: 0.5rem 1rem;
  transition: background-color 0.15s ease-out;
}

.button:hover {
  background-color: #3498db;
  border-color: transparent;
  color: #fff;
}

.button.inactive {
  background-color: #ccc;
  color: #fff;
}

/*--404--*/
.search-goog input {
  border: 2px solid #ddd;
  padding: 10px;
}

.search-goog input[type="submit"] {
  background-color: #ddd;
  cursor: pointer;
}

@media (max-width: 768px) {
  /*--PAGE--*/

  #page,
  .wrapper {
    margin: 0;
    max-width: 100%;
    width: 100%;
  }

  /*--WRAPPER--*/

  .wrapper {
    padding-top: 2rem;
  }

  .wraper::after {
    clear: both;
    content: "";
    display: block;
  }
}

/*--ACCESSIBILITY--*/
.outscreen {
  height: 1px;
  left: -1000px;
  overflow: hidden;
  position: absolute;
  top: auto;
  width: 1px;
}

/*--CALLOUT--*/
.callout {
  border: 1px solid #eee;
  border-left-color: #777;
  border-left-width: 5px;
  border-radius: 3px;
  font-size: 0.9rem;
  padding: 20px;
  margin: 20px 0;
}

.author {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 0.8rem;
  margin-bottom: 1rem;
}

.author .name {
  line-height: 1rem;
  padding-top: 0.5rem;
}

.media,
.bd {
  overflow: hidden;
  _overflow: visible;
  
}

.media .img {
  float: left;
}

.avatar-img {
  border-radius: 100%;
  height: 3rem;
  margin-right: 0.5rem;
  width: 3rem;
}

/* SYNTAX HIGHLIGHTING */

code[class*="language-"],
pre[class*="language-"] {
  color: #393a34;
  font-family: "Consolas", "Bitstream Vera Sans Mono", "Courier New", Courier,
    monospace;
  direction: ltr;
  text-align: left;
  white-space: pre-wrap;
  word-spacing: normal;
  word-break: normal;
  font-size: 0.85em;
  line-height: 1.2em;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

pre[class*="language-"]::-moz-selection,
pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection,
code[class*="language-"] ::-moz-selection {
  background: #b3d4fc;
}

pre[class*="language-"]::selection,
pre[class*="language-"] ::selection,
code[class*="language-"]::selection,
code[class*="language-"] ::selection {
  background: #b3d4fc;
}

/* Code blocks */
pre[class*="language-"] {
  padding: 1em;
  margin: 0.5em 0;
  overflow: auto;
  border: 1px solid #dddddd;
  background-color: white;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: 0.2em;
  padding-top: 1px;
  padding-bottom: 1px;
  background: #f8f8f8;
  border: 1px solid #dddddd;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
  color: #999988;
  font-style: italic;
}

.token.namespace {
  opacity: 0.7;
}

.token.string,
.token.attr-value {
  color: #e3116c;
}
.token.punctuation,
.token.operator {
  color: #393a34; /* no highlight */
}

.token.entity,
.token.url,
.token.symbol,
.token.number,
.token.boolean,
.token.variable,
.token.constant,
.token.property,
.token.regex,
.token.inserted {
  color: #005cc5;
}

.token.keyword {
  color: #d73a49;
}

.token.atrule,
.token.attr-name {
  color: #6f42c1;
}

.token.function,
.token.deleted {
  color: #6f42c1;
}

.token.selector {
  color: #00009f;
}

.token.tag {
  color: #22863a;
}

.token.class-name {
  color: #6f42c1;
}

.token.important,
.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}

.caption,
figcaption {
  display: block;
  font-size: 0.8rem;
  text-align: center;
}

.codepen-aspect-ratio > iframe {
  height: 100%;
  position: absolute;
  width: 100%;
}

.twitter-tweet {
  margin-left: auto;
  margin-right: auto;
}

.twitter-tweet::after {
  content: "";
  display: block;
  padding-bottom: 20px;
  width: 100%;
}

.me {
  max-width: 22rem;
  margin: 0 auto 1rem;
  text-align: center;
}

.me > div {
  height: 8rem;
  margin: 0 auto;
  position: relative;
  width: 8rem;
}

.me svg {
  border-radius: 100%;
  height: 100%;
  left: 0;
  position: absolute;
  top: 0;
  width: 100%;
}

.me img {
  border-radius: 100%;
  height: 100%;
  position: relative;
  width: 100%;
}

.me h1 {
  font-size: 1.7rem;
  line-height: 2rem;
  margin-bottom: 0.5rem;
}

.read-next {
  background-color: #fdf6ea;
  margin: 2rem 0;
  padding: 1em;
}

@media (prefers-color-scheme: dark) {
  body {
    background: #38444c;
    color: #eee;
  }
  a {
    color: #9dcae8;
  }
  a:hover {
    color: #fff;
  }
  p a {
    border-bottom: 1px solid #6d7a82;
  }
  p a:hover {
    border-bottom: 1px solid #fff;
  }
  h1,
  h2,
  h3,
  h4,
  h5 {
    color: #eee;
  }
  a:hover h1,
  a:hover h2,
  a:hover h3,
  a:hover h4,
  a:hover h5 {
    color: #4b89b1;
  }
  .button:hover {
    background-color: #4b89b1;
  }
  code,
  pre {
    color: #ddd;
  }
  .main-header {
    background-color: #4b89b1;
  }
  .read-next {
    background-color: #020915;
  }
}

.amp-img-wrapper {
  position: absolute;
  height: 100%;
  width: 100%;
}
#hexo-amp-id-1{max-width:300px;display:block;margin-left:auto;margin-right:auto}#hexo-amp-id-2{text-align:center}
		
		amp-iframe {
			margin-bottom: 10px;
		}
	</style>
  </head>
  <body>

  	<!-- google analytics -->
  	

  <header class="main-header">
      <nav id="menu">
          <a href="/">JMPerez Blog</a>
          <a href="/projects/">Projects</a>
          <a href="/talks/">Speaking</a>
          <a href="/about-me/">About</a>
      </nav>
  </header>

  <article>
  	<div class="post">
	  	<div id="page">

		    <article id="post-2018/2018-04-06-high-performance-lazy-loading" class="post wrapper">

        <div class="media author">
          <div class="img">
            <a href="/about-me/">
              <amp-img src="/assets/images/jmperez.jpg" class="avatar-img" alt="" height="53" width="53">
            </a>
          </div>
          <div class="bd">
            <address class="name" itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/about-me/" itemprop="name">José M. Pérez</a></address>
            <meta class="post-data" itemprop="datePublished" content="2018-04-06T04:00:00.000Z">
              April 06 2018
            </meta>
          </div>
        </div>

				<!-- entry title -->
				<header class="entry-header">
					
					  <h1 class="article-title entry-title" itemprop="name">
					    Increase the Performance of your Site with Lazy-Loading and Code-Splitting
					  </h1>
					
				</header>

				<!-- entry content -->
			    <div class="entry-content ecp">
			  		<p>Componentization has marked a before and after in web development. The main advantages that are usually mentioned is reusability and modularization. Well defined pieces that we can use to build our sites, like bricks of Legos. It turns out this component structure provides a great foundation to improve the performance of our sites.</p>
<div class="amp-img-wrapper"><amp-img src="https://res.cloudinary.com/jmperez/image/upload/w_auto:100:684,f_auto/v1522995807/high-performance_mbjoct.jpg" width="700" height="365" layout="responsive"></amp-img></div>
<p>We are explicit about our dependencies, so we know what code we need to run to run a specific component. Lazy-loading and bundle splitting can have a huge impact on page performance: less code requested, parsed, and executed. And this not only applies to JavaScript, but every type of asset.</p>
<p>I see many sites that could take advantage of this, and I wanted to show how some basic techniques to load content as needed.</p>
<span id="more"></span>

<p>The article will be using Preact/React, yet the ideas can be applied to any other component library.</p>
<p>We are going to cover several topics:</p>
<ol>
<li> <a href="#Compositional-Patterns">Compositional Patterns</a>: Overview of a couple of patterns that we can use to build complex components.</li>
<li> <a href="#Improving-performance-of-our-sites-by-loading-only-what-is-needed">Improving performance of our sites by loading only what is needed</a>: A practical case where we will apply lazy-loading.</li>
<li> <a href="#A-small-component-to-detect-when-an-area-is-visible">A small component to detect visibility</a>: A simple component that wraps the logic to notify when an element appears on screen.</li>
<li> <a href="#More-use-cases">More use cases</a>: We will see that a component to detect visibility can also be useful in other situations.</li>
<li> <a href="#Polyfilling-IntersectionObserver-on-demand">Polyfilling IntersectionObserver on-demand</a>: How we can include a polyfill only when needed.</li>
<li> <a href="#Code-Splitting-and-CSS-in-JS">Code Splitting and CSS-in-JS</a>: How CSS-in-JS extends code-splitting and lazy-loading to CSS, SVGs and other resources.</li>
<li> <a href="#Useful-implementations">Useful implementations</a>: Existing npm libraries that implement the pattern we have gone through.</li>
</ol>
<p>Let’s start!</p>
<h2 id="Compositional-Patterns"><a href="#Compositional-Patterns" class="headerlink" title="Compositional Patterns"></a>Compositional Patterns</h2><p>In a component world components aren’t only used for rendering actual pixels on the screen. They can also wrap functionality that is passed to children components.</p>
<p>This is usually achieved using <a href="https://reactjs.org/docs/higher-order-components.html">High Order Components (HOC)</a>. These components receive another component and add some functionality, like a behavior.</p>
<p>If you have used redux, the <code>connect</code> function is a HOC that receives your not-connected component. You can find more examples on “<a href="https://medium.com/@franleplant/react-higher-order-components-in-depth-cf9032ee6c3e">React Higher Order Components in depth</a>“ by Fran Guijarro.</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">const</span> MyComponent <span class="token operator">=</span> props <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token entity" title="{">&amp;#123;</span>props<span class="token punctuation">.</span>id<span class="token entity" title="}">&amp;#125;</span> <span class="token operator">-</span> <span class="token entity" title="{">&amp;#123;</span>props<span class="token punctuation">.</span>name<span class="token entity" title="}">&amp;#125;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token keyword">const</span> ConnectedComponent <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>
  mapStateToProps<span class="token punctuation">,</span>
  mapDispatchToProps
<span class="token punctuation">)</span><span class="token punctuation">(</span>MyComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Function as Child Component (also known as “<a href="https://reactpatterns.com/#render-callback">Render Callback</a>“) is another pattern used in similar scenarios. It is getting quite popular these days. You might have come across them in <a href="https://github.com/ReactTraining/react-media">react-media</a> or <a href="https://github.com/jamiebuilds/unstated">unstated</a>.</p>
<p>Look at this example taken from react-media:</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">const</span> MyComponent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Media</span> <span class="token attr-name">query</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(max-width:</span> <span class="token attr-name">599px)"</span><span class="token punctuation">&gt;</span></span>
    <span class="token entity" title="{">&amp;#123;</span>matches <span class="token operator">=</span><span class="token operator">&gt;</span>
      matches <span class="token operator">?</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>The document is less than 600px wide<span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>The document is at least 600px wide<span class="token punctuation">.</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token punctuation">)</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Media</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The <code>Media</code> component calls its children passing a <code>matches</code> argument. This way, the children components don’t need to know about the media query. Componentizing generally makes testing and maintenance easier.</p>
<h2 id="Improving-performance-of-our-sites-by-loading-only-what-is-needed"><a href="#Improving-performance-of-our-sites-by-loading-only-what-is-needed" class="headerlink" title="Improving performance of our sites by loading only what is needed"></a>Improving performance of our sites by loading only what is needed</h2><p>Imagine a typical web page. You can check <a href="https://css-tricks.com/website-sameness/">Website Sameness</a> or <a href="https://www.friday.ie/journal/why-do-all-websites-look-the-same/">Web Design Trends: Why Do All Websites Look The Same?</a> for some inspiration :) . The example page we are going to use contains several sections or blocks:</p>
<ul>
<li>a header (these days, a large hero image taking the whole above-the-fold area)</li>
<li>a section with a few images</li>
<li>another section with a heavy component like a map</li>
<li>a footer</li>
</ul>
<p id="hexo-amp-id-1">
</p><div class="amp-img-wrapper"><amp-img src="https://res.cloudinary.com/jmperez/image/upload/w_auto:100:300,f_auto/v1523084060/observer/site.png" width="300" height="489" layout="responsive"></amp-img></div>
<small class="caption">The basic structure of a page we will be using as example.</small>


<p>This, mapped into React components, would be something like this:</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">const</span> Page <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Header</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Gallery</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Map</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Footer</span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
</code></pre>
<p>When the user visits the page, it is highly likely that they will see the header on screen. After all, it’s the top most component. It is less likely that they see the gallery, map and footer, unless they scroll.</p>
<p>Most times you would include all the scripts and CSS needed to render all sections as soon as the user visits the page. Until recently it was difficult to define a module’s dependencies, and load what was needed.</p>
<p>Years ago, pre-ES6, large companies came up with their own solutions to define dependencies and load them as needed. Yahoo built <a href="https://books.google.com/books?id=E7p-07kNfXYC&amp;pg=PA65&amp;lpg=PA65&amp;dq=yahoo+yui+loader&amp;source=bl&amp;ots=UOcpQHdaRp&amp;sig=AGTHNZvPYXWdU9lkj9klzTEa3ys&amp;hl=en&amp;sa=X&amp;ved=0ahUKEwjn26Wti8PZAhUJDSwKHQOsCbIQ6AEIVDAG#v=onepage&amp;q=yahoo%20yui%20loader&amp;f=false">YUI Loader</a> and Facebook wrote <a href="/facebook-frontend-javascript/">Haste, Bootloader and Primer</a>.</p>
<p>When you send the user code that is not needed, you waste resources from your end, and from the user’s end. More bandwidth to transfer the data, more CPU to parse and execute them, and more memory to keep around. And those assets will steal the limited resources from other critical assets that need it more urgently.</p>
<p>What’s the point in requesting resources that the user will not need, like images that the user won’t reach? Or loading a 3rd party component like a Google Map, with all its additional assets needed to render the thing?</p>
<p>A code coverage report, like <a href="https://developers.google.com/web/updates/2017/04/devtools-release-notes#coverage">the one Google Chrome provides</a> <strong>won’t help us much</strong>. The JS code will be executed and the CSS applied to elements that aren’t visible.</p>
<div class="amp-img-wrapper"><amp-img src="https://res.cloudinary.com/jmperez/image/upload/w_auto:100:684,f_auto/v1522995652/observer/chrome-coverage.png" width="700" height="492" layout="responsive"></amp-img></div>
<p><small class="caption">Code coverage tab on Google Chrome (<a href="https://developers.google.com/web/updates/2017/04/devtools-release-notes#coverage">source</a>)</small></p>
<p>As with everything else, <strong>there are trade-offs with lazy-loading</strong>. We don’t want to apply lazy-loading to everything. Here are some points to take into account.</p>
<ul>
<li><strong>Don’t lazy load above the fold</strong>. In most cases we want the above-the-fold content to be rendered as soon as possible. Every lazy-loading technique will introduce a delay. The browser has to run the JS that injects the HTML to the document, parse it and start requesting the referenced assets.</li>
</ul>
<div class="amp-img-wrapper"><amp-img src="https://res.cloudinary.com/jmperez/image/upload/w_auto:100:684,f_auto/v1522995652/observer/fold.png" width="700" height="434" layout="responsive"></amp-img></div>
<p>Where to set the fold? This is tricky, and it will depend on the user’s device, which varies greatly, and your layout.</p>
<ul>
<li><strong>Lazy load a bit earlier than when it’s needed</strong>. You want to avoid showing void areas to the user. For this, you can load an asset that is needed when it’s closed enough to the visible area. For instance, a user scrolls down and if the image to load is, let’s say, 100px below the bottom of the viewport, start requesting it.</li>
</ul>
<div class="amp-img-wrapper"><amp-img src="https://res.cloudinary.com/jmperez/image/upload/w_auto:100:684,f_auto/v1522995652/observer/preloading.png" width="700" height="434" layout="responsive"></amp-img></div>
<ul>
<li><p>**Invisible content in some scenarios**. You need to take into account that lazy-loaded content won't be shown in some situations:</p>
 - If the lazy-loaded content hasn't been loaded it won't show up when printing the page.
 - The same can happen when the page is shown in RSS readers that might not execute the Javascript needed to load the content.
 - When it comes to SEO, you might have issues indexing lazy-loaded content on Google. At the time of writing this article, Googlebot supports IntersectionObserver and it invokes its callback with changes in the viewport above the fold. However, **it won't trigger the callback for content below the fold**. Thus, **that content won't be seen nor indexed by Google**.
   If you content is important you can, for instance, render the text and lazy-load components like images and other widgets (eg maps).

<p>Here I’m rendering <a href="https://jmperezperez.com/lazy-load/89b6f20e1d79e9fb902242ab84217b12.html">a test page</a> (you can see the source <a href="https://github.com/JMPerez/lazy-load/blob/master/text-above-fold.js">here</a>) using Google Webmaster Tools’ “Fetch as Google”. Googlebot renders the content in the box shown within the viewport, but not the content below it.</p>
<div class="videoWrapper">
  <amp-youtube data-videoid="YEWaufLXX" width="1920" height="1080" layout="responsive"></amp-youtube>
</div>
<small class="caption">Rendering [a test page](https://jmperezperez.com/lazy-load/89b6f20e1d79e9fb902242ab84217b12.html) using Google Webmaster Tools' "Fetch as Google".</small></li>
</ul>
<div class="callout">
<strong>Update May 10th 2019</strong>: Google announced during I/O 2019 that <a href="https://webmasters.googleblog.com/2019/05/the-new-evergreen-googlebot.html">they will use an evergreen Googlebot</a>. This puts an end to using Chrome 41 to render pages and it adds support for IntersectionObserver. If you are using Google Search Console to test how Google renders one of your URLs, you will still get the Chrome 41 result. This is because <a href="https://youtu.be/Ey0N1Ry0BPM?t=381">Google hasn't updated their testing tools to use an evergreen Chrome</a>.
</div>

<h2 id="A-small-component-to-detect-when-an-area-is-visible"><a href="#A-small-component-to-detect-when-an-area-is-visible" class="headerlink" title="A small component to detect when an area is visible"></a>A small component to detect when an area is visible</h2><p>I have talked in the past about <a href="/lazy-loading-images/">lazy-loading images</a>. This is just a type of asset that we can lazy-load, but we can apply the technique to other elements.</p>
<p>Let’s build a simple component that will detect when the section is visible in the viewport. For brevity I will use the <a href="https://developer.mozilla.org/docs/Web/API/Intersection_Observer_API">Intersection Observer API</a>, an experimental technology with <a href="https://caniuse.com/#search=intersectionobserver">quite good support</a>.</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token entity" title="{">&amp;#123;</span> isVisible<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span><span class="token punctuation">[</span>entry<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token entity" title="{">&amp;#123;</span> isVisible<span class="token punctuation">:</span> entry<span class="token punctuation">.</span>isIntersecting <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">,</span> <span class="token entity" title="{">&amp;#123;</span><span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token comment">// we create a div to get a reference.</span>
      <span class="token comment">// It's possible to use findDOMNode() to avoid</span>
      <span class="token comment">// creating extra elements, but findDOMNode is discouraged</span>
      <span class="token operator">&lt;</span>div
        ref<span class="token operator">=</span><span class="token entity" title="{">&amp;#123;</span>div <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> div<span class="token punctuation">;</span>
        <span class="token entity" title="}">&amp;#125;</span><span class="token entity" title="}">&amp;#125;</span>
      <span class="token operator">&gt;</span>
        <span class="token entity" title="{">&amp;#123;</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
          <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>child <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">child</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
<span class="token entity" title="}">&amp;#125;</span>
</code></pre>
<p>The component uses IntersectionObserver to detect that the container intersects with the viewport, that is, it’s visible. We take advantage of React’s lifecycle methods to clean up the IntersectionObserver <a href="https://developer.mozilla.org/docs/Web/API/IntersectionObserver/disconnect">disconnecting it</a> when unmounting.</p>
<p>This basic component could be extended with extra properties passed as <a href="https://developer.mozilla.org/docs/Web/API/Intersection_Observer_API#Intersection_observer_options">options to IntersectionObserver</a> like margins or thresholds, so we can detect elements close to but not intersecting with the viewport. The options are set in the constructor, and they are read-only. Thus, adding support for options means that we would need to reinstantiate the IntersectionObserver with new options when they change, adding some extra logic in <code>componentWillReceiveProps</code> that we are not going to cover here.</p>
<p>Now, we can use this component to lazy load two of our components, <code>Gallery</code> and <code>Map</code>:</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">const</span> Page <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Header</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Observer</span><span class="token punctuation">&gt;</span></span><span class="token entity" title="{">&amp;#123;</span>isVisible <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Gallery</span> <span class="token attr-name">isVisible</span> <span class="token punctuation">/&gt;</span></span><span class="token entity" title="}">&amp;#125;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Observer</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Observer</span><span class="token punctuation">&gt;</span></span><span class="token entity" title="{">&amp;#123;</span>isVisible <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Map</span> <span class="token attr-name">isVisible</span> <span class="token punctuation">/&gt;</span></span><span class="token entity" title="}">&amp;#125;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Observer</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Footer</span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
</code></pre>
<p>In the code above I’m just passing the <code>isVisible</code> property to the <code>Gallery</code> and <code>Map</code> components so they handle it. Alternatively we could return the component if visible, or an empty element otherwise.</p>
<p>In any case <strong>make sure that you reserve the area for the lazy-loaded component</strong>. You don’t want content to jump around, so if you know that your <code>Map</code> is 400px height, render a 400px height empty container before the map is rendered.</p>
<p>How do the <code>Map</code> and <code>Gallery</code> components use the <code>isVisible</code> property? Let’s take a look at the <code>Map</code>:</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Map</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token entity" title="{">&amp;#123;</span> initialized<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>map <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>

  <span class="token function">initializeMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token entity" title="{">&amp;#123;</span> initialized<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// loadScript loads an external script, its definition is not included here.</span>
    <span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token string">'https://maps.google.com/maps/api/js?key=&lt;your_key&gt;'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">const</span> latlng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">google<span class="token punctuation">.</span>maps<span class="token punctuation">.</span>LatLng</span><span class="token punctuation">(</span><span class="token number">38.34</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> myOptions <span class="token operator">=</span> <span class="token entity" title="{">&amp;#123;</span> zoom<span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span> center<span class="token punctuation">:</span> latlng <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">google<span class="token punctuation">.</span>maps<span class="token punctuation">.</span>Map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">,</span> myOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initializeMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token entity" title="}">&amp;#125;</span>

  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>initialized <span class="token operator">&amp;&amp;</span> nextProps<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initializeMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token entity" title="}">&amp;#125;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div
        ref<span class="token operator">=</span><span class="token entity" title="{">&amp;#123;</span>div <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>map <span class="token operator">=</span> div<span class="token punctuation">;</span>
        <span class="token entity" title="}">&amp;#125;</span><span class="token entity" title="}">&amp;#125;</span>
      <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
<span class="token entity" title="}">&amp;#125;</span>
</code></pre>
<p>When the container is displayed in the viewport we make a request to inject Google Map’s script, and once loaded we create the map. This is a good example of lazy-loading JavaScript that is not needed from the beginning, and the rest of resources needed to display the map.</p>
<p>The component has a state to avoid reinjecting the Google Map’s script.</p>
<p>Let’s have a look at the <code>Gallery</code> component:</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">Gallery</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token entity" title="{">&amp;#123;</span> hasBeenVisible<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token entity" title="{">&amp;#123;</span> hasBeenVisible<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasBeenVisible <span class="token operator">&amp;&amp;</span> nextProps<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token entity" title="{">&amp;#123;</span> hasBeenVisible<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Some pictures<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        Picture <span class="token number">1</span><span class="token entity" title="{">&amp;#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasBeenVisible <span class="token operator">?</span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://example.com/image01.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>placeholder<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span>
        Picture <span class="token number">2</span>
        <span class="token entity" title="{">&amp;#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasBeenVisible <span class="token operator">?</span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://example.com/image02.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>placeholder<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
<span class="token entity" title="}">&amp;#125;</span>
</code></pre>
<p>The above example defines another stateful component. In fact, we are storing in the state the same information as we did with the <code>Map</code>.</p>
<p>If the Gallery is shown within the viewport, and afterwards it is outside the viewport, the images will remain in the DOM. In most cases this is what we want when working with images.</p>
<h3 id="Stateless-Child-Components"><a href="#Stateless-Child-Components" class="headerlink" title="Stateless Child Components"></a>Stateless Child Components</h3><p>A stateless component could also be interesting. It would allow us to unload images that are not visible anymore, showing back the placeholders:</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">const</span> Gallery <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token entity" title="{">&amp;#123;</span> isVisible <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Some pictures<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    Picture <span class="token number">1</span><span class="token entity" title="{">&amp;#123;</span>isVisible <span class="token operator">?</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://example.com/image01.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>placeholder<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span>
    Picture <span class="token number">2</span>
    <span class="token entity" title="{">&amp;#123;</span>isVisible <span class="token operator">?</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://example.com/image02.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>placeholder<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>If you do this, <strong>make sure that the images have the right cache response headers</strong> so subsequent requests from the browser hit the cache and it doesn’t download the images again.</p>
<p>If you see yourself making your lazy-loaded components stateful only to track that they have been visible at least once, you can add this logic to the <code>Observer</code> component. After all, <code>Observer</code> is already stateful and it can easily call its children with an additional <code>hasBeenVisible</code> argument.</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">const</span> Page <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token operator">...</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Observer</span><span class="token punctuation">&gt;</span></span>
    <span class="token entity" title="{">&amp;#123;</span><span class="token punctuation">(</span>isVisible<span class="token punctuation">,</span> hasBeenVisible<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Gallery</span> <span class="token attr-name">hasBeenVisible</span> <span class="token punctuation">/&gt;</span></span> <span class="token comment">// Gallery can be now stateless</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Observer</span><span class="token punctuation">&gt;</span></span>
  <span class="token operator">...</span>
<span class="token entity" title="}">&amp;#125;</span>
</code></pre>
<p>Another option is to have a variant of the <code>Observer</code> component that only passes a prop like <code>hasBeenVisible</code>. This has the advantage that we can disconnect the IntersectionObserver as soon as the element is in view, since we are not going to change its value. We will call this component <code>ObserverOnce</code>:</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">ObserverOnce</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token entity" title="{">&amp;#123;</span> hasBeenVisible<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>entries <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
      entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>isIntersecting<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token entity" title="{">&amp;#123;</span> hasBeenVisible<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token entity" title="}">&amp;#125;</span>
      <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">,</span> <span class="token entity" title="{">&amp;#123;</span><span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div
        ref<span class="token operator">=</span><span class="token entity" title="{">&amp;#123;</span>div <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> div<span class="token punctuation">;</span>
        <span class="token entity" title="}">&amp;#125;</span><span class="token entity" title="}">&amp;#125;</span>
      <span class="token operator">&gt;</span>
        <span class="token entity" title="{">&amp;#123;</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
          <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>child <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">child</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasBeenVisible<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>hasBeenVisible<span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
<span class="token entity" title="}">&amp;#125;</span>
</code></pre>
<h2 id="More-use-cases"><a href="#More-use-cases" class="headerlink" title="More use cases"></a>More use cases</h2><p>We have used the <code>Observer</code> component to load resources on-demand. We can also use it to start animating a component as soon as a user sees it.</p>
<p>Here is an example taken from the React Alicante website. It animates some conference numbers as soon as the user scrolls to that section.</p>
<div id="hexo-amp-id-2">
  <amp-video width="1064" height="618" controls="" src="https://res.cloudinary.com/jmperez/video/upload/dpr_auto,f_auto,q_auto/v1522995652/observer/react-alicante.mp4" layout="responsive">
</amp-video></div>

<p>We could recreate it like this (see <a href="https://codepen.io/jmperez/pen/LQXjYv">example on Codepen</a>):</p>
<pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">ConferenceData</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token entity" title="{">&amp;#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token entity" title="{">&amp;#123;</span> progress<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>interval <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>animationDuration <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>startAnimation <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>isVisible <span class="token operator">&amp;&amp;</span>
      nextProps<span class="token punctuation">.</span>isVisible <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>progress <span class="token operator">!==</span> <span class="token number">1</span>
    <span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>startAnimation <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> tick <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token entity" title="{">&amp;#123;</span>
        <span class="token keyword">const</span> progress <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
          <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startAnimation<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>animationDuration
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token entity" title="{">&amp;#123;</span> progress<span class="token punctuation">:</span> progress <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>progress <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
          <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>tick<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token entity" title="}">&amp;#125;</span>
      <span class="token entity" title="}">&amp;#125;</span><span class="token punctuation">;</span>
      <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token entity" title="}">&amp;#125;</span>
  <span class="token entity" title="}">&amp;#125;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token entity" title="{">&amp;#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token entity" title="{">&amp;#123;</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>progress <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span> days ·
        <span class="token entity" title="{">&amp;#123;</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>progress <span class="token operator">*</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span> talks ·
        <span class="token entity" title="{">&amp;#123;</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>progress <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span> workshops ·
        <span class="token entity" title="{">&amp;#123;</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>progress <span class="token operator">*</span> <span class="token number">350</span><span class="token punctuation">)</span><span class="token entity" title="}">&amp;#125;</span> attendees
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token entity" title="}">&amp;#125;</span>
<span class="token entity" title="}">&amp;#125;</span>
</code></pre>
<p>Then, we would use it exactly as the rest of components. This shows the power of abstracting the visibility detection logic outside the components that need them.</p>
<h2 id="Polyfilling-IntersectionObserver-on-demand"><a href="#Polyfilling-IntersectionObserver-on-demand" class="headerlink" title="Polyfilling IntersectionObserver on-demand"></a>Polyfilling IntersectionObserver on-demand</h2><p>So far we have been using IntersectionObserver to detect when an element becomes visible. At the time of this writing some browsers (eg Safari) don’t have support for it, so the instantiation of IntersectionObserver will fail.</p>
<p>An option would be to set <code>isVisible</code> to <code>true</code> when IntersectionObserver is not available, which in practice would disable lazy-loading. In a way we would consider lazy-loading as a progressive enhancement:</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// isVisible is initialized to true if the browser</span>
    <span class="token comment">// does not support IntersectionObserver API</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> isVisible<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>IntersectionObserver<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment">// only initialize the IntersectionObserver if supported</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>IntersectionObserver<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>entries <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token operator">...</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>Another option, which I prefer, is to include a polyfill like <a href="https://github.com/w3c/IntersectionObserver/tree/master/polyfill">w3c’s IntersectionObserver polyfill</a>. This way IntersectionObserver will work in all browsers.</p>
<p>Following with the topic of loading resources on demand, and to lead by example, we will take advantage of code-splitting to only request the polyfill if needed. That way browsers supporting the API don’t need to fetch the polyfill:</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span>window<span class="token punctuation">.</span>IntersectionObserver
      <span class="token operator">?</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">:</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'intersection-observer'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>IntersectionObserver</span><span class="token punctuation">(</span>entries <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> isVisible<span class="token punctuation">:</span> entry<span class="token punctuation">.</span>isIntersecting <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>You can see <a href="https://react-intersection-observer.stackblitz.io/">a demo here</a> (check <a href="https://stackblitz.com/edit/react-intersection-observer">the code source</a>). Safari will make an extra request to load the <code>intersection-observer</code> npm package, since it doesn’t support IntersectionObserver.</p>
<div class="amp-img-wrapper"><amp-img src="https://res.cloudinary.com/jmperez/image/upload/w_auto:100:684,f_auto/v1522995652/observer/safari-intersection-observer-2.jpg" width="700" height="442" layout="responsive"></amp-img></div>
<p><small class="caption">Safari requests the polyfill for intersection-observer on demand. No need to ship it to browsers that support it natively.</small></p>
<p>This is achieved thanks to code splitting. There are tools like <a href="https://parceljs.org/code_splitting.html">Parcel</a> or <a href="https://webpack.js.org/guides/code-splitting/">Webpack</a> that will create a bundle for that imported package, and the logic needed to request the file.</p>
<h2 id="Code-Splitting-and-CSS-in-JS"><a href="#Code-Splitting-and-CSS-in-JS" class="headerlink" title="Code Splitting and CSS-in-JS"></a>Code Splitting and CSS-in-JS</h2><p>So far we have seen how to use a HOC to detect that an element is within the viewport. We have also seen how to load extra JavaScript when needed.</p>
<p>Code-splitting is quite common and straightforward to implement at route level, so the browser loads additional bundles as the user navigates across different URLs on the site. Tools like <a href="https://github.com/ReactTraining/react-router">react-router</a> and <a href="https://github.com/zeit/next.js/">Next.js</a> have made this straightforward to implement.</p>
<p>Through the examples on this post we have seen that the same can be achieved within the same route, loading the code for components on-demand. This is very useful if we have components that need a lot of specific code, not only JavaScript.</p>
<p>A component could link to other resources or even inline them. Think of SVGs or CSS styles.</p>
<p>There is no point in requesting styles that aren’t going to be applied to any element. Dynamically requesting and injecting CSS causes a FOUC (Flash of Unstyled Content). The browser shows the HTML elements with the existing style, and once the additional styles are injected it re-styles the content. With the advent of CSS-in-JS (or JSS) solutions this is no longer a problem. CSS is inlined within the component, and we get true code splitting for our components. <strong>With CSS-in-JS we take code splitting further, loading CSS on demand.</strong></p>
<h2 id="Useful-implementations"><a href="#Useful-implementations" class="headerlink" title="Useful implementations"></a>Useful implementations</h2><p>In this post I have explained how to implement a basic Observer component. There are existing implementations of similar components that have been more battle-tested, support more options and extra ways to integrate in your project.</p>
<p>I definitely recommend you to check out these 2 libraries:</p>
<ul>
<li><a href="https://github.com/thebuilder/react-intersection-observer">thebuilder/react-intersection-observer</a></li>
<li><a href="https://github.com/researchgate/react-intersection-observer">researchgate/react-intersection-observer</a></li>
</ul>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Hopefully I have shown how componentization can make code-splitting and loading resources on demand easier than ever. Define what your code depends on and leverage bundlers and modern tools to request the dependencies as needed when the user navigates to new paths or new components are shown on the page.</p>
<hr>
<p>I would like to thank <a href="https://twitter.com/alexjoverm">@alexjoverm</a>, <a href="https://twitter.com/aarongarciah">@aarongarciah</a> and <a href="https://twitter.com/FlavioCorpa">@FlavioCorpa</a> for reviewing the post, researching similar topics and recommending tools to provide the examples on the page.</p>
<p><em>This post is also available <a href="/es/high-performance-lazy-loading/">in Spanish</a></em></p>
<p>Did you see any typo or wrong information? In that case, <a href="https://twitter.com/jmperezperez">drop me a line</a>.</p>

			  	</div>

		  	</article>
		</div>
    <footer>
        <section class="links">
            <a href="https://twitter.com/jmperezperez">@jmperezperez</a> on Twitter · <a href="https://github.com/JMPerez">GitHub</a> · <a href="http://www.linkedin.com/in/jmperezperez">LinkedIn</a>
        </section>
    </footer>

	</div>
  </article>

  </body>
</html>
