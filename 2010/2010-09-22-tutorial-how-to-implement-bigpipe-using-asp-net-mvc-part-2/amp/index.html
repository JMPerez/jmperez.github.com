<!doctype html>
<html ⚡>
  <head>
    <meta charset="utf-8">
    <link rel="canonical" href="https://jmperezperez.com//tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-2" >
    <title>Tutorial: Implementing Facebook&#39;s BigPipe Using ASP.Net MVC - Part 2 - Web development, performance, and some other good practices.</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
		<meta name="twitter:card" content="summary">
		<meta name="twitter:title" content="Tutorial: Implementing Facebook&#39;s BigPipe Using ASP.Net MVC - Part 2 - José M. Pérez" property="og:title">
		<meta name="twitter:description" content="Build Facebook&#39;s BigPipe using C#. Source code to make pagelets and achieve delayed parallel execution in an ASP.Net MVC website." property="og:description">
		<meta name="twitter:site" content="@jmperezperez">
		
		<meta property="og:image" content="https://res.cloudinary.com/jmperez/image/upload/f_auto,c_scale/v1519156883/profile_ysrm5y.jpg">
		<meta name="twitter:image" content="https://res.cloudinary.com/jmperez/image/upload/f_auto,c_scale/v1519156883/profile_ysrm5y.jpg">
		
    <noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    

    <script async src="https://cdn.ampproject.org/v0.js"></script>
    <script type="application/ld+json">
		{
			"@context": "http://schema.org",
			"@type": "BlogPosting",
			"headline": "Tutorial: Implementing Facebook&#39;s BigPipe Using ASP.Net MVC - Part 2",
			
			"description": "Build Facebook&#39;s BigPipe using C#. Source code to make pagelets and achieve delayed parallel execution in an ASP.Net MVC website.",
			
			"mainEntityOfPage":{
			    "@type":"WebPage",
			    "@id":"/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-2"
			},
			"datePublished": "2010-09-22T17:34:36.000Z",
			"dateModified": "2018-12-16T17:51:46.000Z",
			
			"image": {
				"@type": "ImageObject",
				"url": "/amp-dist/sample/sample-substituteTitleImage.png",
				"width" : "1024",
				"height" : "800"
			},
			
			"author": {
			    "@type": "Person",
			    "name": "Jose M. Perez"
			},
			"publisher": {
			    "@type": "Organization",
			    "name": "Jose M. Perez&#39;s Blog"
			    
			    ,
			    "logo": {
			      "@type": "ImageObject",
			      "url": "https://jmperezperez.com/amp-dist/logo.png",
			      "width": 600,
			      "height": 60
			    }
			    
			}
		}
	</script>
	<style amp-custom>
		
			/*--RESET--*/
* {
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  border: none;
  font: inherit;
  margin: 0;
  padding: 0;
  vertical-align: baseline;
}

input,
button {
  background: none;
}

html {
  font-size: 18px;
}

@media (max-width: 768px) {
  html {
    font-size: 16px;
  }
}

/*--BODY--*/

body {
  background: #fff;
  color: #555;
  font-family: Georgia, Times;
  font-weight: 300;
  font-style: normal;
  line-height: 1.5rem;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-text-size-adjust: 100%; /* fixes a too large font issue in horizontally scrollable <pre> on webkit */
}

h1,
h2,
h3,
h4,
h5 {
  color: #212121;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-weight: 600;
  line-height: 2rem;
  margin-bottom: 1.5rem;
}

#menu a,
.button {
  font-size: 1em;
  font-weight: 400;
}

p,
.post ul,
.post ol,
iframe,
video,
amp-video,
amp-vimeo,
amp-youtube {
  margin: 0;
  margin-bottom: 1rem;
}

twitterwidget {
  margin-bottom: 1em ;
}

a {
  color: #2a7cb2;
  font-weight: inherit;
  text-decoration: none;
  transition: color 0.15s ease-out, border-bottom-color 0.15s ease-out;
}

a:hover {
  color: #2a7cb2;
}

abbr {
  border-bottom: 1px dashed #ccc;
  text-decoration: none;
}

p a {
  border-bottom: 1px solid #eee;
}

p a:hover {
  border-bottom-color: #212121;
}

strong {
  font-weight: bold;
}

em {
  font-style: italic;
}

h1 {
  font-size: 1.7rem;
}

h2 {
  color: #444;
  display: inline-block;
  font-size: 1.6rem;
  font-weight: 400;
  margin-top: 1rem;
}

h3 {
  color: #666;
  display: inline-block;
  font-size: 1.4rem;
  font-weight: 400;
  margin-top: 1rem;
}

h4 {
  font-size: 1.18rem;
}

h5 {
  font-size: 1rem;
}

a h1,
a h2,
a h3,
a h4,
a h5 {
  transition: color 0.15s ease-out;
}

a:hover h1,
a:hover h2,
a:hover h3,
a:hover h4,
a:hover h5 {
  color: #3498db;
}

.quote {
  margin: 0 0 15px 0;
}

blockquote {
  border-left: 2px solid #ccc;
  font-style: italic;
  margin: 0 0 15px 0;
  padding-left: 20px;
}

ul,
ol {
  margin: 0 0 15px 0;
  padding-left: 25px;
}

ul {
  list-style: square;
}

ol {
  list-style: decimal;
}

hr {
  background: #eee;
  color: #eee;
  clear: both;
  display: block;
  height: 2px;
  margin: 30px auto;
  width: 50%;
}

pre,
code {
  color: #333;
  font-family: Courier, Menlo, Monaco;
  font-size: 0.8em;
  letter-spacing: 0px;
  overflow-x: auto;
}

pre {
  padding: 0.8em 1em;
  white-space: pre-wrap;
}

code {
  margin: 0;
}

/*--CLEARFIXES--*/

.post::after {
  display: block;
  clear: both;
  content: "";
}

/*--HEADER--*/

.main-header {
  background-color: #005689;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  overflow: hidden;
  margin-bottom: 1.5rem;
  padding: 1rem;
  position: relative;
  text-align: center;
  width: 100%;
}

/*--MENU--*/

#menu {
  display: inline-block;
  line-height: 2rem;
}

#menu a {
  color: #fff;
  font-size: 0.9rem;
  margin-left: 1rem;
  padding: 1rem 0.5rem;
  text-transform: uppercase;
}

@media (max-width: 500px) {
  #menu a {
    margin-left: 0.5rem;
    padding: 0.5rem 0.25rem;
  }
}

#menu a:first-child {
  margin-left: 0;
}

#menu a[aria-current] {
  font-weight: bold;
}

/*--PAGE--*/

#page {
  margin: 0 auto;
  max-width: 41rem;
  padding-left: 1.5rem;
  padding-right: 1.5rem;
  position: relative;
}

.videoWrapper {
  height: 0;
  margin-bottom: 1em;
  padding-bottom: 56.25%; /* 16:9 */
  padding-top: 25px;
  position: relative;
}

.videoWrapper iframe,
.videoWrapper amp-youtube {
  height: 100%;
  left: 0;
  position: absolute;
  top: 0;
  width: 100%;
}

/*--WRAPPER--*/

.wrapper {
  border-top: 2px solid #eee;
  padding-top: 2rem;
}

.wrapper:first-child {
  border-top: none;
  padding-top: 1rem;
}

.posts-list h2 {
  margin-top: 0;
}

/*--POSTS--*/

.post {
  display: block;
  margin-bottom: 2rem;
  width: 100%;
}

.post div[itemprop="articleBody"] > p:first-child {
  color: #333;
}

.post li {
  margin-bottom: 0.5rem;
}

.post p + img {
  margin-bottom: 1rem;
}

.post p img {
  border: 1px solid #eee;
  display: block;
  max-width: 100%;
}

.post img + .caption,
.post img + figcaption {
  padding-top: 0.5rem;
}

.post .svg-container {
  margin-bottom: 5%;
  max-width: 100%;
  text-align: center;
}

figure {
  padding-bottom: 1em;
}

video {
  height: auto;
  max-width: 100%;
}

.post .svg-container object {
  width: 100%;
}

.tag-list {
  display: inline-block;
  list-style-type: none;
  margin: 0;
  padding: 0;
  padding-bottom: 1rem;
}

.tag-list-item {
  display: inline-block;
  margin-left: 0.8em;
}

/*--PAGINATION--*/

.pagination {
  padding-bottom: 1rem;
  text-align: center;
}

.pagination a {
  min-width: 30px;
  max-height: 30px;
  text-align: center;
}

/*--FOOTER--*/

footer {
  border-top: 1px dashed #ddd;
  padding: 2em;
  text-align: center;
}

.timing-stats {
  font-size: 0.7em;
  padding: 0.35em;
}

/*--BUTTONS--*/

.button {
  background-color: #fff;
  border: 1px solid #555;
  border-radius: 2rem;
  color: #555;
  display: inline-block;
  padding: 0.5rem 1rem;
  transition: background-color 0.15s ease-out;
}

.button:hover {
  background-color: #3498db;
  border-color: transparent;
  color: #fff;
}

.button.inactive {
  background-color: #ccc;
  color: #fff;
}

/*--404--*/
.search-goog input {
  border: 2px solid #ddd;
  padding: 10px;
}

.search-goog input[type="submit"] {
  background-color: #ddd;
  cursor: pointer;
}

@media (max-width: 768px) {
  /*--PAGE--*/

  #page,
  .wrapper {
    margin: 0;
    max-width: 100%;
    width: 100%;
  }

  /*--WRAPPER--*/

  .wrapper {
    padding-top: 2rem;
  }

  .wraper::after {
    clear: both;
    content: "";
    display: block;
  }
}

/*--ACCESSIBILITY--*/
.outscreen {
  height: 1px;
  left: -1000px;
  overflow: hidden;
  position: absolute;
  top: auto;
  width: 1px;
}

/*--CALLOUT--*/
.callout {
  border: 1px solid #eee;
  border-left-color: #777;
  border-left-width: 5px;
  border-radius: 3px;
  font-size: 0.9rem;
  padding: 20px;
  margin: 20px 0;
}

.author {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 0.8rem;
  margin-bottom: 1rem;
}

.author .name {
  line-height: 1rem;
  padding-top: 0.5rem;
}

.media,
.bd {
  overflow: hidden;
  _overflow: visible;
  
}

.media .img {
  float: left;
}

.avatar-img {
  border-radius: 100%;
  height: 3rem;
  margin-right: 0.5rem;
  width: 3rem;
}

/* SYNTAX HIGHLIGHTING */

code[class*="language-"],
pre[class*="language-"] {
  color: #393a34;
  font-family: "Consolas", "Bitstream Vera Sans Mono", "Courier New", Courier,
    monospace;
  direction: ltr;
  text-align: left;
  white-space: pre-wrap;
  word-spacing: normal;
  word-break: normal;
  font-size: 0.85em;
  line-height: 1.2em;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

pre[class*="language-"]::-moz-selection,
pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection,
code[class*="language-"] ::-moz-selection {
  background: #b3d4fc;
}

pre[class*="language-"]::selection,
pre[class*="language-"] ::selection,
code[class*="language-"]::selection,
code[class*="language-"] ::selection {
  background: #b3d4fc;
}

/* Code blocks */
pre[class*="language-"] {
  padding: 1em;
  margin: 0.5em 0;
  overflow: auto;
  border: 1px solid #dddddd;
  background-color: white;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: 0.2em;
  padding-top: 1px;
  padding-bottom: 1px;
  background: #f8f8f8;
  border: 1px solid #dddddd;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
  color: #999988;
  font-style: italic;
}

.token.namespace {
  opacity: 0.7;
}

.token.string,
.token.attr-value {
  color: #e3116c;
}
.token.punctuation,
.token.operator {
  color: #393a34; /* no highlight */
}

.token.entity,
.token.url,
.token.symbol,
.token.number,
.token.boolean,
.token.variable,
.token.constant,
.token.property,
.token.regex,
.token.inserted {
  color: #005cc5;
}

.token.keyword {
  color: #d73a49;
}

.token.atrule,
.token.attr-name {
  color: #6f42c1;
}

.token.function,
.token.deleted {
  color: #6f42c1;
}

.token.selector {
  color: #00009f;
}

.token.tag {
  color: #22863a;
}

.token.class-name {
  color: #6f42c1;
}

.token.important,
.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}

.caption,
figcaption {
  display: block;
  font-size: 0.8rem;
  text-align: center;
}

.codepen-aspect-ratio > iframe {
  height: 100%;
  position: absolute;
  width: 100%;
}

.twitter-tweet {
  margin-left: auto;
  margin-right: auto;
}

.twitter-tweet::after {
  content: "";
  display: block;
  padding-bottom: 20px;
  width: 100%;
}

.me {
  max-width: 22rem;
  margin: 0 auto 1rem;
  text-align: center;
}

.me > div {
  height: 8rem;
  margin: 0 auto;
  position: relative;
  width: 8rem;
}

.me svg {
  border-radius: 100%;
  height: 100%;
  left: 0;
  position: absolute;
  top: 0;
  width: 100%;
}

.me img {
  border-radius: 100%;
  height: 100%;
  position: relative;
  width: 100%;
}

.me h1 {
  font-size: 1.7rem;
  line-height: 2rem;
  margin-bottom: 0.5rem;
}

.read-next {
  background-color: #fdf6ea;
  margin: 2rem 0;
  padding: 1em;
}

@media (prefers-color-scheme: dark) {
  body {
    background: #38444c;
    color: #eee;
  }
  a {
    color: #9dcae8;
  }
  a:hover {
    color: #fff;
  }
  p a {
    border-bottom: 1px solid #6d7a82;
  }
  p a:hover {
    border-bottom: 1px solid #fff;
  }
  h1,
  h2,
  h3,
  h4,
  h5 {
    color: #eee;
  }
  a:hover h1,
  a:hover h2,
  a:hover h3,
  a:hover h4,
  a:hover h5 {
    color: #4b89b1;
  }
  .button:hover {
    background-color: #4b89b1;
  }
  code,
  pre {
    color: #ddd;
  }
  .main-header {
    background-color: #4b89b1;
  }
  .read-next {
    background-color: #020915;
  }
}

.amp-img-wrapper {
  position: absolute;
  height: 100%;
  width: 100%;
}

		
		amp-iframe {
			margin-bottom: 10px;
		}
	</style>
  </head>
  <body>

  	<!-- google analytics -->
  	

  <header class="main-header">
      <nav id="menu">
          <a href="/">JMPerez Blog</a>
          <a href="/projects/">Projects</a>
          <a href="/talks/">Speaking</a>
          <a href="/about-me/">About</a>
      </nav>
  </header>

  <article>
  	<div class="post">
	  	<div id="page">

		    <article id="post-2010/2010-09-22-tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-2" class="post wrapper">

        <div class="media author">
          <div class="img">
            <a href="/about-me/">
              <amp-img src="/assets/images/jmperez.jpg" class="avatar-img" alt="" height="53" width="53">
            </a>
          </div>
          <div class="bd">
            <address class="name" itemprop="author" itemscope itemtype="https://schema.org/Person"><a href="/about-me/" itemprop="name">José M. Pérez</a></address>
            <meta class="post-data" itemprop="datePublished" content="2010-09-22T17:34:36.000Z">
              September 22 2010
            </meta>
          </div>
        </div>

				<!-- entry title -->
				<header class="entry-header">
					
					  <h1 class="article-title entry-title" itemprop="name">
					    Tutorial: Implementing Facebook&#39;s BigPipe Using ASP.Net MVC - Part 2
					  </h1>
					
				</header>

				<!-- entry content -->
			    <div class="entry-content ecp">
			  		<p>Parts of the tutorial</p>
<ol>
<li> <a href="/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-1">Introduction to BigPipe</a></li>
<li> How ASP.Net MVC fits in the model. Registering and generating pagelets</li>
<li><a href="/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-3">Browser implementation of BigPipe. Loading pagelets and their
 resources effectively</a></li>
<li> <a href="https://github.com/JMPerez/BigPipe">Check out the demo Visual Studio solution</a></li>
</ol>
<p>In <a href="/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-1">the previous post of this tutorial</a> I made an overview explaining how Bigpipe works and why it can improve users’ perceived speed when loading our pages.</p>
<!-- more -->
<p>Basically Bigpipe combines early flushing, parallel processing and a managed resources loading in the browser to prioritize showing content quickly over loading and executing JavaScript files.</p>
<p>In this second post I will show how ASP.Net MVC features fit in the BigPipe model. Code snippets will help to illustrate he different parts. I will upload the source code in a Visual Studio 2010 project during the next days, so you can download it and further explore this technique.</p>
<h2 id="View-structure"><a href="#View-structure" class="headerlink" title="View structure"></a>View structure</h2><p>Our view structure will be the usual when working with ASP.Net MVC:</p>
<ul>
<li><code>Site.Master</code>: Contains the skeleton of the HTML document. It will
  also fire the execution of the pagelets.</li>
<li><code>SomePage.aspx</code>: Fills the ContentPlaceHolders of the Site.Master.
  It will include the different pagelets.</li>
<li><code>Pagelet1.ascx</code>, <code>Pagelet2.ascx</code>… : The partial views that
  provides content to some areas that compose the page.</li>
</ul>
<h2 id="Pagelets-as-RenderActions"><a href="#Pagelets-as-RenderActions" class="headerlink" title="Pagelets as RenderActions"></a>Pagelets as RenderActions</h2><p>Our pagelets will be included using RenderActions. Pagelets are supposed
to take some time to be executed, so it makes sense that these will need
to access data in some way. These data will be retrieved in a controller
to keep MVC paradigm.</p>
<h2 id="Registering-pagelets"><a href="#Registering-pagelets" class="headerlink" title="Registering pagelets"></a>Registering pagelets</h2><p>First of all, we will declare a Pagelet class that is going to be used
to register the Pagelets. A pagelet will contain an instance of Data,
that will be serialized as JSON.</p>
<pre class=" language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Data</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Id <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Content <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span> Css <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span> Js <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Pagelet</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> JavaScriptSerializer jss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaScriptSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Func<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span> Action <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">readonly</span> <span class="token keyword">string</span> Container<span class="token punctuation">;</span>
    <span class="token keyword">public</span> Data Data <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Manages a pagelet</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name=container&gt;The id of the div container in which the output will be appended&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name=action&gt;The action to execute that will generate the output&lt;/param&gt;</span>
    <span class="token keyword">public</span> <span class="token function">Pagelet</span><span class="token punctuation">(</span><span class="token keyword">string</span> container<span class="token punctuation">,</span> Func<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span> action<span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Container <span class="token operator">=</span> container<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Action <span class="token operator">=</span> action<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> Id <span class="token operator">=</span> container <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Content <span class="token operator">=</span> <span class="token function">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">string</span> <span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span> <span class="token keyword">var</span> js_pagelet <span class="token operator">=</span>
            <span class="token operator">+</span> jss<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>Data<span class="token punctuation">)</span>
            <span class="token operator">+</span> <span class="token punctuation">;</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>\
            <span class="token operator">+</span> Container
            <span class="token operator">+</span> \<span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> js_pagelet<span class="token punctuation">.</span>Content<span class="token punctuation">;</span> <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>The Js and Css arrays of strings will contain the files of these types needed by the pagelet to be styled and work correctly (in the next post I will make heavier use of these fields when covering the Javascript script).</p>
<p>The <code>Serialize()</code> method will generate the code to make the call to inject the code into its container.</p>
<p>Next, we will define some helpers that will be used to register the pagelet and store the output of the RenderAction call.</p>
<p>We want the rendered content to be converted into a JSON object so, instead of just rendering the action (writing the output directly to the response), we will render the action storing the result in a string. For this, we will use RenderActionToString.</p>
<p>We need a way to get the result of the RenderAction as a string. Following a similar method to the one used to <a href="http://www.klopfenstein.net/lorenz.aspx/render-partial-view-to-string-in-asp-net-mvc">render a partial view to a string</a>, we can declare extension methods to get the output of an action:</p>
<pre class=" language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RendererHelper</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment">/// &lt;summary&gt;Fake IView implementation, only used to instantiate an HtmlHelper.&lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FakeView</span> <span class="token punctuation">:</span> IView
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token preprocessor property">#<span class="token directive keyword">region</span> IView Members</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Render</span><span class="token punctuation">(</span>ViewContext viewContext<span class="token punctuation">,</span> System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>TextWriter writer<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotImplementedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">string</span> <span class="token function">RenderActionToString</span><span class="token punctuation">(</span><span class="token keyword">this</span> HtmlHelper helper<span class="token punctuation">,</span> HttpRequest request<span class="token punctuation">,</span> <span class="token keyword">string</span> controller<span class="token punctuation">,</span> <span class="token keyword">string</span> action<span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment">//Create memory writer</span>
        <span class="token keyword">var</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> memWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringWriter</span><span class="token punctuation">(</span>sb<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//Create fake http context to render the view</span>
        <span class="token keyword">var</span> fakeResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">(</span>memWriter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> fakeContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpContext</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> fakeResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> fakeControllerContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ControllerContext</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">HttpContextWrapper</span><span class="token punctuation">(</span>fakeContext<span class="token punctuation">)</span><span class="token punctuation">,</span>
            helper<span class="token punctuation">.</span>ViewContext<span class="token punctuation">.</span>RouteData<span class="token punctuation">,</span>
            helper<span class="token punctuation">.</span>ViewContext<span class="token punctuation">.</span>Controller<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> oldContext <span class="token operator">=</span> HttpContext<span class="token punctuation">.</span>Current<span class="token punctuation">;</span>
        HttpContext<span class="token punctuation">.</span>Current <span class="token operator">=</span> fakeContext<span class="token punctuation">;</span>

        <span class="token comment">//Use HtmlHelper to render partial view to fake context</span>
        <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HtmlHelper</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ViewContext</span><span class="token punctuation">(</span>fakeControllerContext<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">FakeView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ViewDataDictionary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TempDataDictionary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memWriter<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ViewPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        html<span class="token punctuation">.</span><span class="token function">RenderAction</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> controller<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//Restore context</span>
        HttpContext<span class="token punctuation">.</span>Current <span class="token operator">=</span> oldContext<span class="token punctuation">;</span>

        <span class="token comment">//Flush memory and return output</span>
        memWriter<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>HtmlHelper already has the <code>Action</code> method extension that gets the result of an action in a string, but it can be problematic when using multiple threads to execute the pagelets, as I explain in the <a href="/tutorial-how-to-implement-bigpipe-using-asp-net-mvc-part-3">third part of this tutorial</a>.</p>
<pre class=" language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BigPipeHelper</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">RegisterPagelet</span><span class="token punctuation">(</span><span class="token keyword">this</span> HtmlHelper helper<span class="token punctuation">,</span> Pagelet pagelet<span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> context <span class="token operator">=</span> helper<span class="token punctuation">.</span>ViewContext<span class="token punctuation">.</span>HttpContext<span class="token punctuation">;</span>
        <span class="token keyword">bool</span> jsEnabled <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Cookies<span class="token punctuation">[</span>js<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Cookies<span class="token punctuation">[</span>js<span class="token punctuation">]</span><span class="token punctuation">.</span>Value <span class="token operator">==</span> <span class="token keyword">true</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>jsEnabled<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment">//JavaScript is not enabled, so we write the execution to the output and</span>
            <span class="token comment">//not register the pagelet</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pagelet<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Css <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">string</span> css <span class="token keyword">in</span> pagelet<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Css<span class="token punctuation">)</span>
                    helper<span class="token punctuation">.</span><span class="token function">IncludeCss</span><span class="token punctuation">(</span>css<span class="token punctuation">)</span><span class="token punctuation">;</span>

            pagelet<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>div id<span class="token operator">=</span>\<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token number">0</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>\<span class="token operator">&gt;</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token number">1</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">,</span> pagelet<span class="token punctuation">.</span>Container<span class="token punctuation">,</span> pagelet<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        List<span class="token operator">&lt;</span>Pagelet<span class="token operator">&gt;</span> pagelets <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Pagelet<span class="token operator">&gt;</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>Pagelets<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pagelets <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            pagelets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>Pagelet<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>Pagelets<span class="token punctuation">]</span> <span class="token operator">=</span> pagelets<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        pagelets<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>pagelet<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//write pagelet container</span>
        context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>div id<span class="token operator">=</span>\ <span class="token operator">+</span> pagelet<span class="token punctuation">.</span>Container <span class="token operator">+</span> \<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>We will use <a href="http://www.4guysfromrolla.com/articles/060904-1.aspx">HttpContext.Items</a> to store the pagelets. The aspx page will decide to render each action or register a pagelet for later execution, depending on Javascript support. When using BigPipe we will choose the later one.</p>
<p>Then, in Site.Master, just before closing the body tag, we will make a flush so the browser can process the code generated so far, and then we will start executing the pagelets.</p>
<pre class=" language-html"><code class="language-html">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>%</span> <span class="token attr-name">Response.Flush();</span> <span class="token attr-name">%</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>%</span> <span class="token attr-name">Html.ExecutePagelets();</span> <span class="token attr-name">%</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>The pagelets will be executed in a set of parallel threads. Each thread will execute the render action and will write a Javascript call to process the pagelet. After writing this response, we will flush it so the browser can start processing the code for the just generated pagelet.</p>
<pre class=" language-csharp"><code class="language-csharp"><span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token keyword">object</span> _locker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ExecutePagelets</span><span class="token punctuation">(</span><span class="token keyword">this</span> HtmlHelper helper<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> context <span class="token operator">=</span> helper<span class="token punctuation">.</span>ViewContext<span class="token punctuation">.</span>HttpContext<span class="token punctuation">;</span>
    List<span class="token operator">&lt;</span>Pagelet<span class="token operator">&gt;</span> pagelets <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Pagelet<span class="token operator">&gt;</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>Pagelets<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pagelets <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    Parallel<span class="token punctuation">.</span><span class="token function">For</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pagelets<span class="token punctuation">.</span>Count<span class="token punctuation">,</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> pagelet <span class="token operator">=</span> pagelets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        pagelet<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">lock</span><span class="token punctuation">(</span>_locker<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>pagelet<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>Parallel.For (C# 4.0) creates a set of threads and continues with the next instruction once they all have finished. For each pagelet, we store in the Content field the result of executing its Action() method, this is, the output of the RenderAction. Next we write to the output the Data object as a JSON string and flush it.</p>
<h3 id="Implementing-the-browser-side-of-Bigpipe"><a href="#Implementing-the-browser-side-of-Bigpipe" class="headerlink" title="Implementing the browser side of Bigpipe"></a>Implementing the browser side of Bigpipe</h3><p>I did not want to make just a proof of concept of Bigpipe, but also implement a basic system that covers this technique from the server to the browser.</p>
<p>In the next post I will focus on the script that will manage the loading of CSS and JavaScript resources for the pagelets. This script is independent of the technology and programming language used on server. I will also show some resources loading charts to see how BigPipe affects this.</p>
<p><strong>Update September 26th:</strong> I add a locker in the <code>ExecutePagelets</code> method to make response writing thread safe.</p>
<p><strong>Update September 27th:</strong> I add support for javascript disabled browser, generating content immediately when registering pagelets in <code>RegisterPagelet</code> method.</p>

			  	</div>

		  	</article>
		</div>
    <footer>
        <section class="links">
            <a href="https://twitter.com/jmperezperez">@jmperezperez</a> on Twitter · <a href="https://github.com/JMPerez">GitHub</a> · <a href="http://www.linkedin.com/in/jmperezperez">LinkedIn</a>
        </section>
    </footer>

	</div>
  </article>

  </body>
</html>
