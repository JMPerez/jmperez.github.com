<!doctype html><html lang=en><head><meta name=generator content="Hexo 3.8.0"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta http-equiv=Accept-CH content="DPR, Viewport-Width, Width"><title>Using WebP to create tiny preview images - José M. Pérez</title><meta name=description content="Following with the image optimization topic, I am going to have a deeper look to Facebook's technique to create preview photos, and will show how WebP can simplify their solution."><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"><link rel=author href=https://plus.google.com/107456024651797783420><link rel=alternate type=application/rss+xml title="Jose M. Perez" href=https://jmperezperez.com/feed.xml><meta name=twitter:card content=summary_large_image><meta name=twitter:url content="https://jmperezperez.com/webp-placeholder-images/" property=og:url><meta name=twitter:title content="Using WebP to create tiny preview images - José M. Pérez" property=og:title><meta name=twitter:description content="Following with the image optimization topic, I am going to have a deeper look to Facebook's technique to create preview photos, and will show how WebP can simplify their solution." property=og:description><meta name=twitter:site content=@jmperezperez><meta property=og:image content=https://jmperezperez.com/assets/images/posts/webp-vs-jpeg-preview-photos.jpg><meta name=twitter:image content=https://jmperezperez.com/assets/images/posts/webp-vs-jpeg-preview-photos.jpg><meta property=fb:app_id content=1702266270006013><meta property=fb:pages content=1639848659664211><link rel=canonical href="https://jmperezperez.com/webp-placeholder-images/"><style>*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;border:none;font:inherit;margin:0;padding:0;vertical-align:baseline}button,input{background:0 0}html{font-size:18px}@media (max-width:768px){html{font-size:16px}}body{background:#fff;color:#555;font-family:Georgia,Times;font-weight:300;font-style:normal;line-height:1.5rem;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-text-size-adjust:100%}h1,h2,h3,h4,h5{color:#212121;font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;font-weight:600;line-height:2rem;margin-bottom:1.5rem}#menu a,.button{font-size:1em;font-weight:400}.post ol,.post ul,amp-video,amp-vimeo,amp-youtube,iframe,p,video{margin:0;margin-bottom:1rem}twitterwidget{margin-bottom:1em!important}a{color:#2a7cb2;font-weight:inherit;text-decoration:none;transition:color .15s ease-out,border-bottom-color .15s ease-out}a:hover{color:#2a7cb2}abbr{border-bottom:1px dashed #ccc;text-decoration:none}p a{border-bottom:1px solid #eee}p a:hover{border-bottom-color:#212121}strong{font-weight:700}em{font-style:italic}h1{font-size:1.7rem}h2{color:#444;display:inline-block;font-size:1.6rem;font-weight:400;margin-top:1rem}h3{color:#666;display:inline-block;font-size:1.4rem;font-weight:400;margin-top:1rem}h4{font-size:1.18rem}h5{font-size:1rem}a h1,a h2,a h3,a h4,a h5{transition:color .15s ease-out}a:hover h1,a:hover h2,a:hover h3,a:hover h4,a:hover h5{color:#3498db}.quote{margin:0 0 15px 0}blockquote{border-left:2px solid #ccc;font-style:italic;margin:0 0 15px 0;padding-left:20px}ol,ul{margin:0 0 15px 0;padding-left:25px}ul{list-style:square}ol{list-style:decimal}hr{background:#eee;color:#eee;clear:both;display:block;height:2px;margin:30px auto;width:50%}code,pre{color:#333;font-family:Courier,Menlo,Monaco;font-size:.8em;letter-spacing:0;overflow-x:auto}pre{padding:.8em 1em;white-space:pre-wrap}code{margin:0}.post::after{display:block;clear:both;content:''}.main-header{background-color:#005689;font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;overflow:hidden;margin-bottom:1.5rem;padding:1rem;position:relative;text-align:center;width:100%}#menu{display:inline-block;line-height:2rem}#menu a{color:#fff;font-size:.9rem;margin-left:1rem;padding:1rem .5rem;text-transform:uppercase}@media (max-width:500px){#menu a{margin-left:.5rem;padding:.5rem .25rem}}#menu a:first-child{margin-left:0}#menu a[aria-current]{font-weight:700}#page{margin:0 auto;max-width:41rem;padding-left:1.5rem;padding-right:1.5rem;position:relative}.videoWrapper{height:0;margin-bottom:1em;padding-bottom:56.25%;padding-top:25px;position:relative}.videoWrapper amp-youtube,.videoWrapper iframe{height:100%;left:0;position:absolute;top:0;width:100%}.wrapper{border-top:2px solid #eee;padding-top:2rem}.wrapper:first-child{border-top:none;padding-top:1rem}.posts-list h2{margin-top:0}.post{display:block;margin-bottom:2rem;width:100%}.post div[itemprop=articleBody]>p:first-child{color:#333}.post li{margin-bottom:.5rem}.post p+img{margin-bottom:1rem}.post p img{border:1px solid #eee;display:block;max-width:100%}.post img+.caption{padding-top:.5rem}.post .svg-container{margin-bottom:5%;max-width:100%;text-align:center}video{height:auto;max-width:100%}.post .svg-container object{width:100%}.tag-list{display:inline-block;list-style-type:none;margin:0;padding:0;padding-bottom:1rem}.tag-list-item{display:inline-block;margin-left:.8em}.pagination{padding-bottom:1rem;text-align:center}.pagination a{min-width:30px;max-height:30px;text-align:center}footer{border-top:1px dashed #ddd;padding:2em;text-align:center}.timing-stats{font-size:.7em;padding:.35em}.button{background-color:#fff;border:1px solid #555;border-radius:2rem;color:#555;display:inline-block;padding:.5rem 1rem;transition:background-color .15s ease-out}.button:hover{background-color:#3498db;border-color:transparent;color:#fff}.button.inactive{background-color:#ccc;color:#fff}.search-goog input{border:2px solid #ddd;padding:10px}.search-goog input[type=submit]{background-color:#ddd;cursor:pointer}@media (max-width:768px){#page,.wrapper{margin:0;max-width:100%;width:100%}.wrapper{padding-top:2rem}.wraper::after{clear:both;content:'';display:block}}.outscreen{height:1px;left:-1000px;overflow:hidden;position:absolute;top:auto;width:1px}.callout{border:1px solid #eee;border-left-color:#777;border-left-width:5px;border-radius:3px;font-size:.9rem;padding:20px;margin:20px 0}.author{font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;font-size:.8rem;margin-bottom:1rem}.author .name{line-height:1rem;padding-top:.5rem}.bd,.media{overflow:hidden;zoom:1}.media .img{float:left}.avatar-img{border-radius:100%;height:3rem;margin-right:.5rem;width:3rem}code[class*=language-],pre[class*=language-]{color:#393a34;font-family:Consolas,'Bitstream Vera Sans Mono','Courier New',Courier,monospace;direction:ltr;text-align:left;white-space:pre-wrap;word-spacing:normal;word-break:normal;font-size:.85em;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{background:#b3d4fc}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#b3d4fc}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border:1px solid #ddd;background-color:#fff}:not(pre)>code[class*=language-]{padding:.2em;padding-top:1px;padding-bottom:1px;background:#f8f8f8;border:1px solid #ddd}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#998;font-style:italic}.token.namespace{opacity:.7}.token.attr-value,.token.string{color:#e3116c}.token.operator,.token.punctuation{color:#393a34}.token.boolean,.token.constant,.token.entity,.token.inserted,.token.number,.token.property,.token.regex,.token.symbol,.token.url,.token.variable{color:#005cc5}.token.keyword{color:#d73a49}.token.atrule,.token.attr-name{color:#6f42c1}.token.deleted,.token.function{color:#6f42c1}.token.selector{color:#00009f}.token.tag{color:#22863a}.token.class-name{color:#6f42c1}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.caption{display:block;font-size:.8rem;text-align:center}.codepen-aspect-ratio>iframe{height:100%;position:absolute;width:100%}.twitter-tweet{margin-left:auto;margin-right:auto}.twitter-tweet::after{content:'';display:block;padding-bottom:20px;width:100%}.me{max-width:22rem;margin:0 auto 1rem;text-align:center}.me>div{height:8rem;margin:0 auto;position:relative;width:8rem}.me svg{border-radius:100%;height:100%;left:0;position:absolute;top:0;width:100%}.me img{border-radius:100%;height:100%;position:relative;width:100%}.me h1{font-size:1.7rem;line-height:2rem;margin-bottom:.5rem}@media (prefers-color-scheme:dark){body{background:#38444c;color:#eee}a{color:#9dcae8}a:hover{color:#fff}p a{border-bottom:1px solid #6d7a82}p a:hover{border-bottom:1px solid #fff}h1,h2,h3,h4,h5{color:#eee}a:hover h1,a:hover h2,a:hover h3,a:hover h4,a:hover h5{color:#4b89b1}.button:hover{background-color:#4b89b1}code,pre{color:#ddd}.main-header{background-color:#4b89b1}}</style><link rel=amphtml href="/webp-placeholder-images/amp/"><meta name=theme-color content=#005689><link rel=manifest href=/manifest.json></head><body><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-39254352-1","auto"),ga("send","pageview");</script><header class=main-header><nav id=menu><a href="/">Blog</a> <a href="/projects/">Projects</a> <a href="/talks/">Speaking</a> <a href="/about-me/?ref=header">About</a></nav></header><div id=page><article class=wrapper><div class=post><header><script type=application/ld+json>{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Using WebP to create tiny preview images",
  
  "description": "Following with the image optimization topic, I am going to have a deeper look to Facebook's technique to create preview photos, and will show how WebP can simplify their solution.",
  
  "mainEntityOfPage":{
      "@type":"WebPage",
      "@id":"https://jmperezperez.com/webp-placeholder-images/"
  },
  "datePublished": "2015-11-28T10:30:00.000Z",
  "dateModified": "2018-12-16T17:51:46.000Z",
  
  "image": {
    "@type": "ImageObject",
    "url": "https://jmperezperez.com/assets/images/posts/webp-vs-jpeg-preview-photos.jpg",
    "width" : "704",
    "height" : "210"
  },
  
  "author": {
      "@type": "Person",
      "name": "Jose M. Perez",
      "url": "https://jmperezperez.com",
      "sameAs": [
        "http://www.linkedin.com/in/jmperezperez",
        "https://twitter.com/jmperezperez"
      ]
  },
  "publisher": {
      "@type": "Organization",
      "name": "Jose M. Perez's Blog"
      
      ,
      "logo": {
        "@type": "ImageObject",
        "url": "https://jmperezperez.com/assets/images/logo.png",
        "width": 600,
        "height": 60
      }
      
  }
}</script><div class="media author"><div class=img><a href="/about-me/?ref=post-header"><img src=https://res.cloudinary.com/jmperez/image/upload/w_120,f_auto,c_scale/v1519156883/profile_ysrm5y.jpg class=avatar-img alt="" height=53 width=53 sizes=53px></a></div><div class=bd><address class=name itemprop=author itemscope="" itemtype=https://schema.org/Person><a href="/about-me/" itemprop=name>José M. Pérez</a></address><meta class=post-data itemprop=datePublished content=2015-11-28T10:30:00.000Z>November 28, 2015 <span style="margin:0 .5rem;display:inline-block">|</span> Reading Time: ~<time>5 mins</time></div></div><h1>Using WebP to create tiny preview images</h1></header><p>Following with the image optimization topic, I am going to have a deeper look to <a href="https://code.facebook.com/posts/991252547593574/the-technology-behind-preview-photos/" target=_blank rel=noopener>Facebook’s technique to create <em>preview</em> photos</a>, and will show how WebP can simplify their solution.</p><p><img src=/assets/images/posts/webp-vs-jpeg-preview-photos.jpg alt="WebP vs JPEG when encoding tiny images"></p><p><strong>tl;dr</strong> WebP produces tiny files when compressing small images. This makes it ideal for implementing <em>preview photos</em>. <a href="/demos/webp-preview/">Check the demo</a>.</p><a id=more></a><p>In a recent article I talked about <a href="/medium-image-progressive-loading-placeholder/">an image loading technique used by Medium</a> that combined a small blurry preview plus a transition to the final image. This approach has been used for some time by other sites and mobile applications, and it is getting even more focus these days as major websites try to expand in countries with very slow internet connections.</p><p>Facebook is one of them and explained some months ago <a href="https://code.facebook.com/posts/991252547593574/the-technology-behind-preview-photos/" target=_blank rel=noopener>how they inlined preview photos</a>.</p><h2 id=Finding-out-the-right-image-dimensions><a href=#Finding-out-the-right-image-dimensions class=headerlink title="Finding out the right image dimensions"></a>Finding out the right image dimensions</h2><p>There is a direct relation between the dimensions of the image, its size in bytes, and the radius for the blur effect that needs to be applied to smooth the big upscaled pixels. In addition, we need to take into account the rendered dimensions of the image: we will want a larger preview the larger the rendered size is.</p><p>Facebook found that, for their mobile client, the sweet spot for the preview size was 42×42px. Then, they tried to generate the smallest (in bytes) image that they could serve with those dimensions. JPEG was the winning format, and they worked on reducing the file size even further by making the mobile client prepend a common header image and only transmit the basic image data.</p><h2 id=Taking-this-approach-to-the-web><a href=#Taking-this-approach-to-the-web class=headerlink title="Taking this approach to the web"></a>Taking this approach to the web</h2><p>If we want to use the same technique on a website, we need to:</p><ol><li>Send image data.</li><li>Send the header.</li><li>Send the JS code that will glue the header and the data together.</li></ol><p>In the case of a mobile app, the code for (2) and (3) is shipped as part of the app. But in a website we need to send it as part of the response. This means that, at least the first time the user visits our page, there won’t be large savings using this technique. For subsequent requests, we could use cached JS or a Service Worker to do the glueing process.</p><p>But not everything is lost.</p><h2 id=Using-a-different-image-format><a href=#Using-a-different-image-format class=headerlink title="Using a different image format"></a>Using a different image format</h2><p>I wondered how other format files performed in file size when saving small files. I tried with PNG and GIF, and both of them were larger than JPG. Then I have it a try to WebP and I was surprised on how well it compresses images.</p><h3 id=How-I-resized-and-compressed-the-images><a href=#How-I-resized-and-compressed-the-images class=headerlink title="How I resized and compressed the images"></a>How I resized and compressed the images</h3><p><strong><a href="/demos/webp-preview/">In this page</a> you can see the demo and all the source images generated</strong></p><p>First, I downloaded some 64×64px cover art images using the <a href="https://developer.spotify.com/web-api/console/get-artist-albums/?id=61C3cEhdoJ9YiQSQSwYB4K" target=_blank rel=noopener>Spotify Web API</a>. I wanted to use square images with a consistent small size.</p><p>Then I used Photoshop to create a 42×42px JPEG version of the files, with the minimum quality settings (that is, max compression). Then I passed them through <a href="https://imageoptim.com/" target=_blank rel=noopener>ImageOptim</a>, that saved around 66% of the file size using a lossless optimization. The final average file size is 478 bytes. <a href=/assets/images/posts/imageoptim-jpg-optimization.png><img src=/assets/images/posts/imageoptim-jpg-optimization.png alt="ImageOptim squeezing JPGs"></a></p><p>Note that Facebook don’t mention what the size for their images was:</p><blockquote><p>“Unfortunately, the standard JPEG header is hundreds of bytes in size. In fact, the JPEG header alone is several times bigger than our entire 200-byte budget. However, excluding the JPEG header, the encoded data payload itself was approaching our 200 bytes” - taken from <a href="https://code.facebook.com/posts/991252547593574/the-technology-behind-preview-photos/" target=_blank rel=noopener>The technology behind preview photos</a>.</p></blockquote><p>For the WebP version I used Photoshop to create a 42×42 px JPEG version of the files, but this time with the maximum quality settings. This is to make sure that I didn’t introduce artifacts that WebP had to encode. Then again, I passed the files through ImageOptim, reducing the file size around 25%, to an average of 2.5kB.</p><p>Finally, I run <a href=https://developers.google.com/speed/webp/docs/using target=_blank rel=noopener><code>cwebp</code></a> to generate WebP images from the JPEG version, with the minimum quality:</p><pre class=language-bash><code class=language-bash><span class="token keyword">for</span> f <span class="token keyword">in</span> *.jpg<span class="token punctuation">;</span> <span class="token keyword">do</span> cwebp -q 0 <span class="token variable">$f</span> -o <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> $f .jpg<span class="token variable">)</span></span>"</span>.webp<span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre><p>The resulting WebP images have a file size between 90 and 202 bytes, with an average of 121 bytes. That is <strong>25% of an equivalent JPG image</strong>. <a href=/assets/images/posts/webp-vs-jpeg-preview-photos.jpg><img src=/assets/images/posts/webp-vs-jpeg-preview-photos.jpg alt="WebP vs JPEG encoding tiny placeholder images"></a></p><p>The artifacts generated by JPEG and WebP are quite different, but in any case, when smoothed using blur, they look almost identical: <a href=/assets/images/posts/webp-vs-jpeg-preview-photos-blur.jpg><img src=/assets/images/posts/webp-vs-jpeg-preview-photos-blur.jpg alt="WebP vs JPEG encoding tiny placeholder images after applying a small blur effect"></a></p><p>Remember that these images are always shown with a blur effect, to smooth artifacts and pixels.</p><h3 id=Medium’s-Progressive-Loading-Inlined-WebP><a href=#Medium’s-Progressive-Loading-Inlined-WebP class=headerlink title="Medium’s Progressive Loading + Inlined WebP"></a>Medium’s Progressive Loading + Inlined WebP</h3><p>I have forked the CodePen I created on <a href="/medium-image-progressive-loading-placeholder/">How Medium does progressive image loading</a> to show how it works with WebP. You will need a browser that supports WebP to see the full effect. Otherwise, you can <a href=/assets/images/posts/webp-progressive-image-loading.mp4>watch this video</a> showing the effect.</p><p>I have resized the original image to a 42×28px thumbnail, converted to WebP and generated its Data URI:</p><pre><code>data:image/webp;base64,UklGRnoAAABXRUJQVlA4IG4AAABQBQCdASoqABwAP/3+/3+/urWyMBVYA/A/iWIAAR7p/Y3etgh4KD8QqXEZj6waibITSIAA/cndnUz4/z4LEgByYUql75Cq/12W33KFIKQpc8L0Dt19C7NFXin0tKlxd70dzSF978msbuqLjDgAAA==
</code></pre><p>That’s 199 characters. And this is the result:</p><iframe id=cp_embed_QjeWVv src="//codepen.io/jmperez/embed/QjeWVv?height=403&theme-id=0&slug-hash=QjeWVv&default-tab=result" scrolling=no frameborder=no height=403 allowtransparency=true allowfullscreen=true class=cp_embed_iframe data-amp-width=100% style="width: 100%; overflow: hidden"></iframe><p>You can see it better <a href="http://codepen.io/jmperez/full/QjeWVv/" target=_blank rel=noopener>in full screen</a>. I recommend that you use network throttling and disable cache to notice the full animation.</p><h2 id=Conclusion><a href=#Conclusion class=headerlink title=Conclusion></a>Conclusion</h2><p>We have managed to create a file within the 200 bytes budget without having to mess with the headers nor fancy low-level hacks. <em>Here’s when I wonder if it would be possible to strip the header of the WebP files and get even higher savings</em>.</p><p>For the web, <a href="http://caniuse.com/#feat=webp" target=_blank rel=noopener>WebP can only be used in Chrome and Opera</a>, which limits its applicability in the real world. Interestingly for Facebook’s use case, WebP is supported on native mobile apps on <a href=https://github.com/carsonmcdonald/WebP-iOS-example target=_blank rel=noopener>iOS</a> and <a href=https://github.com/EverythingMe/webp-android target=_blank rel=noopener>Android</a>, so they could well use WebP as an alternative to their <em>technology</em>.</p></div><hr>Tags:<ul class=tag-list><li class=tag-list-item><a class=tag-list-link href="/tags/facebook/">facebook</a></li><li class=tag-list-item><a class=tag-list-link href="/tags/images/">images</a></li><li class=tag-list-item><a class=tag-list-link href="/tags/ux/">ux</a></li><li class=tag-list-item><a class=tag-list-link href="/tags/webp/">webp</a></li></ul></article></div><script>"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js").then(function(n){})["catch"](function(n){})});</script><footer><section class=links><a href=https://twitter.com/jmperezperez>@jmperezperez</a> on Twitter · <a href=https://github.com/JMPerez>GitHub</a> · <a href=https://www.linkedin.com/in/jmperezperez>LinkedIn</a> · <a href=https://medium.com/@jmperezperez>Medium</a></section><div class=timing-stats></div></footer><script>window.addEventListener('load', () => {
     setTimeout(() => {
      var t = window.performance && performance.timing;
      function round2(num) { return Math.round(num * 100) / 100; }
      if (t) {
        var timingStats = document.querySelector('.timing-stats');
        var loadTime = (t.loadEventEnd - t.navigationStart) / 1000;
        var timingStatsHTML = 'This page loaded in ' + round2(loadTime) + ' seconds. ';
        var performanceEntries = performance.getEntriesByType('paint');
        performanceEntries.forEach(function(performanceEntry, i, entries) {
          var name = performanceEntry.name;
          if (name === 'first-paint') {
            name = '<abbr title=' + name + '>FP</abbr>';
          } else if (name === 'first-contentful-paint') {
            name = '<abbr title=' + name + '>FCP</abbr>';
          }
          timingStatsHTML += name + ' was ' + round2(performanceEntry.startTime / 1000) + ' seconds. ';
        });
        timingStatsHTML += '<a href="https://jmperezperez.com/page-load-footer/">More info</a>.';
        timingStats.innerHTML = timingStatsHTML;
      }
    }, 0);
   });</script><script src=/quicklink.js async></script></body></html>